<artifacts>
<invoke name="artifacts">
<parameter name="command">rewrite</parameter>
<parameter name="type">text/html</parameter>
<parameter name="title">CVW Dashboard - Complete Inter-Agency System</parameter>
<parameter name="id">cvw_dashboard_complete_final</parameter>
<parameter name="content"><!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CVW Case Reports Analytics Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
    }
/* Login Screen Styles */
.login-container {
    max-width: 400px;
    margin: 10% auto;
    background: rgba(255, 255, 255, 0.95);
    border-radius: 20px;
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
    backdrop-filter: blur(10px);
    padding: 40px;
    text-align: center;
}

.login-header {
    margin-bottom: 30px;
}

.login-header h1 {
    color: #2c3e50;
    font-size: 2rem;
    margin-bottom: 10px;
}

.login-header p {
    color: #7f8c8d;
    font-size: 1rem;
}

.login-form {
    margin-bottom: 30px;
}

.login-input {
    width: 100%;
    padding: 15px;
    margin-bottom: 15px;
    border: 2px solid #dee2e6;
    border-radius: 10px;
    font-size: 16px;
    transition: all 0.3s ease;
}

.login-input:focus {
    outline: none;
    border-color: #667eea;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}

.login-btn {
    width: 100%;
    padding: 15px;
    background: linear-gradient(135deg, #667eea, #764ba2);
    color: white;
    border: none;
    border-radius: 10px;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
}

.login-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
}

.demo-accounts {
    background: #f8f9fa;
    border-radius: 10px;
    padding: 20px;
    margin-top: 20px;
}

.demo-accounts h3 {
    color: #2c3e50;
    margin-bottom: 15px;
    font-size: 1.1rem;
}

.account-demo {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
    padding: 8px;
    background: white;
    border-radius: 5px;
    font-size: 0.9rem;
}

.account-type {
    font-weight: 600;
    color: #495057;
}

.account-credentials {
    color: #6c757d;
    font-family: monospace;
}

.login-error {
    background: #fee2e2;
    color: #dc2626;
    padding: 10px;
    border-radius: 8px;
    margin-bottom: 15px;
    display: none;
}

/* User Info Bar */
.user-info-bar {
    background: rgba(255, 255, 255, 0.9);
    padding: 10px 20px;
    border-radius: 10px;
    margin-bottom: 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
}

.user-details {
    display: flex;
    align-items: center;
    gap: 15px;
}

.user-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: linear-gradient(135deg, #667eea, #764ba2);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: bold;
    font-size: 1.2rem;
}

.user-info {
    display: flex;
    flex-direction: column;
}

.user-name {
    font-weight: 600;
    color: #2c3e50;
}

.user-role {
    font-size: 0.8rem;
    color: #7f8c8d;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.logout-btn {
    padding: 8px 16px;
    background: #dc3545;
    color: white;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    font-size: 0.9rem;
    transition: all 0.3s ease;
}

.logout-btn:hover {
    background: #c82333;
}

/* Role-based styling */
.role-admin .user-avatar { background: linear-gradient(135deg, #28a745, #20c997); }
.role-viewer .user-avatar { background: linear-gradient(135deg, #17a2b8, #6f42c1); }
.role-reporter .user-avatar { background: linear-gradient(135deg, #ffc107, #fd7e14); }

/* Agency Selection Styles */
.agency-btn {
    background: white;
    border: 3px solid #dee2e6;
    border-radius: 15px;
    padding: 20px;
    min-width: 200px;
    cursor: pointer;
    transition: all 0.3s ease;
    text-align: center;
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
}

.agency-btn:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
    border-color: #667eea;
}

.agency-btn.selected {
    border-color: #667eea;
    background: linear-gradient(135deg, #667eea, #764ba2);
    color: white;
}

.agency-btn.selected .agency-code {
    color: #fff;
    background: rgba(255, 255, 255, 0.2);
}

.agency-icon {
    font-size: 2rem;
    margin-bottom: 10px;
}

.agency-name {
    font-weight: 600;
    font-size: 1rem;
    margin-bottom: 8px;
    color: #2c3e50;
}

.agency-btn.selected .agency-name {
    color: white;
}

.agency-code {
    font-family: 'Courier New', monospace;
    font-weight: bold;
    font-size: 0.9rem;
    background: #f8f9fa;
    color: #495057;
    padding: 4px 8px;
    border-radius: 4px;
    display: inline-block;
}

/* Disabled button styling */
.action-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    transform: none !important;
    box-shadow: none !important;
}

.action-btn:disabled:hover {
    transform: none !important;
    box-shadow: none !important;
}

/* Dashboard Styles */
.dashboard-container {
    max-width: 1400px;
    margin: 0 auto;
    background: rgba(255, 255, 255, 0.95);
    border-radius: 20px;
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
    backdrop-filter: blur(10px);
    padding: 30px;
}

.header {
    text-align: center;
    margin-bottom: 30px;
    padding-bottom: 20px;
    border-bottom: 3px solid #667eea;
}

.header h1 {
    color: #2c3e50;
    font-size: 2.5rem;
    margin-bottom: 10px;
    text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
}

.header p {
    color: #7f8c8d;
    font-size: 1.1rem;
}

.zambia-label {
    font-family: 'Algerian', serif;
    font-size: 24px;
    font-weight: bold;
    color: #2c3e50;
    margin: 10px 0;
}

.connection-status {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    margin: 15px 0;
    padding: 10px;
    border-radius: 8px;
    font-weight: 600;
    font-size: 0.9rem;
}

.status-connected {
    background: #d1fae5;
    color: #059669;
    border: 1px solid #10b981;
}

.status-disconnected {
    background: #fee2e2;
    color: #dc2626;
    border: 1px solid #ef4444;
}

.status-indicator {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    animation: pulse 2s infinite;
}

.status-connected .status-indicator {
    background: #10b981;
}

.status-disconnected .status-indicator {
    background: #ef4444;
}

@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
}

.action-buttons {
    display: flex;
    justify-content: center;
    gap: 15px;
    margin-bottom: 30px;
}

.action-btn {
    padding: 12px 24px;
    border: none;
    border-radius: 10px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    font-size: 14px;
    display: flex;
    align-items: center;
    gap: 8px;
}

.add-record-btn {
    background: linear-gradient(135deg, #10b981, #059669);
    color: white;
}

.add-record-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(16, 185, 129, 0.3);
}

.view-dashboard-btn {
    background: linear-gradient(135deg, #667eea, #764ba2);
    color: white;
}

.view-dashboard-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
}

/* Hidden elements for different roles */
.hidden { display: none !important; }

/* Access denied message */
.access-denied {
    text-align: center;
    padding: 50px;
    color: #dc3545;
    background: #f8f9fa;
    border-radius: 10px;
    margin: 20px 0;
}

.access-denied h2 {
    margin-bottom: 10px;
}

/* Modal Styles */
.modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
    backdrop-filter: blur(5px);
}

.modal-content {
    background: white;
    margin: 2% auto;
    padding: 30px;
    border-radius: 20px;
    width: 90%;
    max-width: 800px;
    max-height: 90vh;
    overflow-y: auto;
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 25px;
    padding-bottom: 15px;
    border-bottom: 2px solid #ecf0f1;
}

.modal-title {
    font-size: 1.5rem;
    font-weight: 600;
    color: #2c3e50;
}

.close {
    color: #95a5a6;
    font-size: 28px;
    font-weight: bold;
    cursor: pointer;
    transition: color 0.3s ease;
}

.close:hover {
    color: #e74c3c;
}

.form-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 20px;
}

.form-group {
    display: flex;
    flex-direction: column;
}

.form-group label {
    font-weight: 600;
    color: #495057;
    margin-bottom: 8px;
    font-size: 0.9rem;
}

.form-group input,
.form-group select,
.form-group textarea {
    padding: 12px 15px;
    border: 2px solid #dee2e6;
    border-radius: 8px;
    background: white;
    font-size: 14px;
    transition: all 0.3s ease;
}

.form-group input:focus,
.form-group select:focus,
.form-group textarea:focus {
    outline: none;
    border-color: #667eea;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}

.full-width {
    grid-column: 1 / -1;
}

.form-actions {
    display: flex;
    justify-content: flex-end;
    gap: 15px;
    margin-top: 30px;
    padding-top: 20px;
    border-top: 2px solid #ecf0f1;
}

.cancel-btn {
    padding: 12px 24px;
    background: #95a5a6;
    color: white;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 600;
    transition: all 0.3s ease;
}

.cancel-btn:hover {
    background: #7f8c8d;
}

.submit-btn {
    padding: 12px 24px;
    background: linear-gradient(135deg, #10b981, #059669);
    color: white;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 600;
    transition: all 0.3s ease;
}

.submit-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(16, 185, 129, 0.3);
}

.filters-section {
    background: linear-gradient(135deg, #f8f9fa, #e9ecef);
    padding: 20px;
    border-radius: 15px;
    margin-bottom: 30px;
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
}

.filters-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
    align-items: end;
}

.filter-group {
    display: flex;
    flex-direction: column;
}

.filter-group label {
    font-weight: 600;
    color: #495057;
    margin-bottom: 5px;
    font-size: 0.9rem;
}

.filter-group select,
.date-input {
    padding: 10px 15px;
    border: 2px solid #dee2e6;
    border-radius: 8px;
    background: white;
    font-size: 14px;
    transition: all 0.3s ease;
}

.filter-group select:focus,
.date-input:focus {
    outline: none;
    border-color: #667eea;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}

.reset-btn {
    padding: 10px 20px;
    background: linear-gradient(135deg, #ff6b6b, #ee5a52);
    color: white;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 600;
    transition: all 0.3s ease;
    height: fit-content;
}

.reset-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(238, 90, 82, 0.3);
}

.kpi-section {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.kpi-card {
    background: linear-gradient(135deg, #667eea, #764ba2);
    color: white;
    padding: 25px;
    border-radius: 15px;
    text-align: center;
    box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
    transition: all 0.3s ease;
}

.kpi-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 15px 40px rgba(102, 126, 234, 0.4);
}

.kpi-value {
    font-size: 2.5rem;
    font-weight: 700;
    margin-bottom: 5px;
    text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
}

.kpi-label {
    font-size: 1rem;
    opacity: 0.9;
    font-weight: 500;
}

.charts-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
    gap: 25px;
    margin-bottom: 30px;
}

.chart-container {
    background: white;
    padding: 25px;
    border-radius: 15px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
    transition: all 0.3s ease;
}

.chart-container:hover {
    transform: translateY(-3px);
    box-shadow: 0 15px 40px rgba(0, 0, 0, 0.15);
}

.chart-title {
    font-size: 1.2rem;
    font-weight: 600;
    color: #2c3e50;
    margin-bottom: 20px;
    text-align: center;
    padding-bottom: 10px;
    border-bottom: 2px solid #ecf0f1;
}

.chart-canvas {
    max-height: 300px;
}

.table-container {
    background: white;
    border-radius: 15px;
    padding: 25px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
    overflow: hidden;
}

.data-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.9rem;
}

.data-table th {
    background: linear-gradient(135deg, #667eea, #764ba2);
    color: white;
    padding: 15px 10px;
    text-align: left;
    font-weight: 600;
    position: sticky;
    top: 0;
    z-index: 10;
}

.data-table td {
    padding: 12px 10px;
    border-bottom: 1px solid #ecf0f1;
    transition: background-color 0.2s ease;
}

.data-table tr:hover td {
    background-color: #f8f9fa;
}

.table-wrapper {
    max-height: 400px;
    overflow-y: auto;
    border-radius: 10px;
    border: 1px solid #dee2e6;
}

.loading {
    display: flex;
    justify-content: center;
    align-items: center;
    height: 200px;
    font-size: 1.2rem;
    color: #667eea;
}

.spinner {
    border: 4px solid #f3f3f3;
    border-top: 4px solid #667eea;
    border-radius: 50%;
    width: 40px;
    height: 40px;
    animation: spin 1s linear infinite;
    margin-right: 15px;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.status-badge {
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 0.8rem;
    font-weight: 600;
    text-transform: uppercase;
}

.victim-badge { background: #fee2e2; color: #dc2626; }
.witness-badge { background: #dbeafe; color: #2563eb; }

.success-message {
    background: #d1fae5;
    color: #059669;
    padding: 12px 20px;
    border-radius: 8px;
    margin-bottom: 20px;
    border-left: 4px solid #10b981;
    display: none;
}

.error-message {
    background: #fee2e2;
    color: #dc2626;
    padding: 12px 20px;
    border-radius: 8px;
    margin-bottom: 20px;
    border-left: 4px solid #ef4444;
    display: none;
}

/* Enhanced Age Input Styling */
.age-input-container {
    display: flex;
    gap: 10px;
    align-items: center;
}

.age-input-container input {
    flex: 2;
}

.age-input-container select {
    flex: 1;
}

/* Age display in tables with color coding */
.age-display {
    font-weight: 500;
    padding: 2px 6px;
    border-radius: 4px;
    white-space: nowrap;
}

.age-display.infant {
    background-color: #fee2e2;
    color: #dc2626;
    font-weight: 600;
}

.age-display.toddler {
    background-color: #fed7aa;
    color: #ea580c;
    font-weight: 600;
}

.age-display.child {
    background-color: #dcfce7;
    color: #059669;
}

.age-display.teen {
    background-color: #dbeafe;
    color: #2563eb;
}

/* Highlight months selection */
select option[value="months"] {
    background-color: #fef2f2;
    font-weight: 600;
}

/* Form validation styling */
input:invalid {
    border-color: #ef4444;
}

input:valid {
    border-color: #10b981;
}

.age-help-text {
    color: #666;
    font-size: 0.8rem;
    margin-top: 5px;
    font-style: italic;
}

@media (max-width: 768px) {
    .dashboard-container {
        padding: 15px;
    }
    
    .header h1 {
        font-size: 2rem;
    }
    
    .charts-grid {
        grid-template-columns: 1fr;
    }
    
    .filters-grid {
        grid-template-columns: 1fr;
    }

    .form-grid {
        grid-template-columns: 1fr;
    }

    .modal-content {
        width: 100%;
        height: 100%;
        margin: 0;
        padding: 15px;
        border-radius: 0;
        max-height: 100vh;
        overflow-y: auto;
    }

    .modal {
        padding: 0;
    }

    .action-buttons {
        flex-direction: column;
        align-items: center;
        gap: 10px;
    }

    .action-btn {
        width: 90%;
        max-width: 300px;
        padding: 15px;
        font-size: 16px;
    }

    .age-input-container {
        flex-direction: column;
        gap: 8px;
    }

    .age-input-container input,
    .age-input-container select {
        flex: none;
        width: 100%;
        padding: 15px;
        font-size: 16px;
    }

    .form-group input,
    .form-group select {
        padding: 15px;
        font-size: 16px;
        border-radius: 8px;
    }

    .user-info-bar {
        flex-direction: column;
        gap: 10px;
        text-align: center;
    }

    #agencySelection {
        margin-bottom: 10px;
    }

    #agencySelection > div {
        flex-direction: column;
        gap: 10px;
    }

    .agency-btn {
        min-width: auto;
        width: 100%;
        padding: 25px 15px;
        font-size: 14px;
    }

    .login-container {
        margin: 5% auto;
        width: 95%;
        padding: 30px 20px;
    }

    .submit-btn, .cancel-btn {
        padding: 15px 25px;
        font-size: 16px;
        min-height: 50px;
    }

    /* Mobile form improvements */
    .form-group label {
        font-size: 16px;
        margin-bottom: 10px;
    }

    .modal-title {
        font-size: 1.3rem;
        line-height: 1.4;
    }

    /* Ensure tap targets are at least 44px */
    button, .action-btn, .agency-btn {
        min-height: 44px;
        touch-action: manipulation;
    }

    /* Prevent zoom on input focus for iOS */
    input, select, textarea {
        font-size: 16px !important;
        transform-origin: left top;
    }
}
</style>
</head>
<body>
    <!-- Login Screen -->
    <div id="loginScreen" class="login-container">
        <div class="login-header">
            <h1>üîê CVW Dashboard</h1>
            <p>Zambia Child Victim & Witness Analytics</p>
        </div>
<div class="login-error" id="loginError">
        ‚ùå Invalid username or password
    </div>
<form class="login-form" id="loginForm">
    <input type="text" id="username" class="login-input" placeholder="Username" required>
    <input type="password" id="password" class="login-input" placeholder="Password" required>
    <button type="submit" class="login-btn">üöÄ Login</button>
</form>

<div class="demo-accounts">
    <h3>üìã Demo Accounts</h3>
    <div class="account-demo">
        <span class="account-type">üëë Admin</span>
        <span class="account-credentials">admin / admin123</span>
    </div>
    <div class="account-demo">
        <span class="account-type">üëÄ Viewer</span>
        <span class="account-credentials">viewer / view123</span>
    </div>
    <div class="account-demo">
        <span class="account-type">üìù Reporter</span>
        <span class="account-credentials">reporter / report123</span>
    </div>
</div>
</div>
<!-- Main Dashboard -->
<div id="mainDashboard" class="hidden">
    <!-- User Info Bar -->
    <div id="userInfoBar" class="user-info-bar">
        <div class="user-details">
            <div id="userAvatar" class="user-avatar">A</div>
            <div class="user-info">
                <div id="userName" class="user-name">Administrator</div>
                <div id="userRole" class="user-role">Admin Account</div>
            </div>
        </div>
        <button class="logout-btn" onclick="logout()">üö™ Logout</button>
    </div>
<div class="dashboard-container">
    <div class="header">
        <h1>üìä CVW Case Reports Analytics</h1>
        <p class="zambia-label">Zambia</p>
        <p>Comprehensive Analysis of Child Victim & Witness Cases</p>
        
        <!-- Database Connection Status -->
        <div id="connectionStatus" class="connection-status">
<div class="status-indicator"></div>
                    <span i
<artifacts>
<invoke name="artifacts">
<parameter name="command">update</parameter>
<parameter name="id">cvw_dashboard_complete_final</parameter>
<parameter name="old_str">            <!-- Database Connection Status -->
            <div id="connectionStatus" class="connection-status">
<div class="status-indicator"></div>
                    <span i</parameter>
<parameter name="new_str">            <!-- Database Connection Status -->
            <div id="connectionStatus" class="connection-status">
                <div class="status-indicator"></div>
                <span id="statusText">Checking database connection...</span>
            </div>
        </div>
<!-- Reporting Agency Selection (For Admin and Reporter) -->
    <div id="agencySelection" class="filters-section hidden" style="margin-bottom: 20px;">
        <h3 style="text-align: center; color: #2c3e50; margin-bottom: 20px;">üèõÔ∏è Select Reporting Agency</h3>
        <div style="display: flex; justify-content: center; gap: 15px; flex-wrap: wrap;">
            <button class="agency-btn" data-agency="NPA" onclick="selectAgency('NPA')">
                <div class="agency-icon">‚öñÔ∏è</div>
                <div class="agency-name">National Prosecution Authority</div>
                <div class="agency-code">NPA</div>
            </button>
            <button class="agency-btn" data-agency="MOH" onclick="selectAgency('MOH')">
                <div class="agency-icon">üè•</div>
                <div class="agency-name">Ministry of Health</div>
                <div class="agency-code">MOH</div>
            </button>
            <button class="agency-btn" data-agency="ZP" onclick="selectAgency('ZP')">
                <div class="agency-icon">üëÆ</div>
                <div class="agency-name">Zambia Police</div>
                <div class="agency-code">ZP</div>
            </button>
        </div>
    </div>

    <!-- Action Buttons (Role-based visibility) -->
    <div class="action-buttons" id="actionButtons">
        <button class="action-btn add-record-btn" id="addRecordBtn" onclick="openAddRecordModal()" disabled>
            ‚ûï Add New Record
        </button>
        <button class="action-btn" id="searchCaseBtn" style="background: linear-gradient(135deg, #17a2b8, #6f42c1);" onclick="openSearchCaseModal()" disabled>
            üîç Search Case
        </button>
        <button class="action-btn view-dashboard-btn" id="viewDashboardBtn" onclick="showDashboardView()">
            üìà View Dashboard
        </button>
        <button class="action-btn" id="clearDataBtn" style="background: linear-gradient(135deg, #ff6b6b, #ee5a52);" onclick="clearAllData()" title="Clear all locally saved data">
            üóëÔ∏è Clear Data
        </button>
    </div>

    <!-- Filters Section (Hidden for Reporter) -->
    <div class="filters-section" id="filtersSection">
        <div class="filters-grid">
            <div class="filter-group">
                <label for="districtFilter">District</label>
                <select id="districtFilter">
                    <option value="">All Districts</option>
                </select>
            </div>
            <div class="filter-group">
                <label for="recordTypeFilter">Record Type</label>
                <select id="recordTypeFilter">
                    <option value="">All Types</option>
                    <option value="Victim">Victim</option>
                    <option value="Witness">Witness</option>
                </select>
            </div>
            <div class="filter-group">
                <label for="crimeTypeFilter">Crime Type</label>
                <select id="crimeTypeFilter">
                    <option value="">All Crime Types</option>
                </select>
            </div>
            <div class="filter-group">
                <label for="genderFilter">Gender</label>
                <select id="genderFilter">
                    <option value="">All Genders</option>
                    <option value="MALE">Male</option>
                    <option value="FEMALE">Female</option>
                </select>
            </div>
            <div class="filter-group">
                <label for="dateFromFilter">Date From</label>
                <input type="date" id="dateFromFilter" class="date-input">
            </div>
            <div class="filter-group">
                <label for="dateToFilter">Date To</label>
                <input type="date" id="dateToFilter" class="date-input">
            </div>
            <div class="filter-group">
                <label for="servicesFilter">Services Rendered</label>
                <select id="servicesFilter">
                    <option value="">All Services</option>
                </select>
            </div>
            <div class="filter-group">
                <button class="reset-btn" onclick="resetFilters()">üîÑ Reset Filters</button>
            </div>
        </div>
    </div>

    <!-- KPI Section (Hidden for Reporter) -->
    <div class="kpi-section" id="kpiSection">
        <div class="kpi-card">
            <div class="kpi-value" id="totalCases">0</div>
            <div class="kpi-label">Total Cases</div>
        </div>
        <div class="kpi-card">
            <div class="kpi-value" id="victimCases">0</div>
            <div class="kpi-label">Victim Cases</div>
        </div>
        <div class="kpi-card">
            <div class="kpi-value" id="witnessCases">0</div>
            <div class="kpi-label">Witness Cases</div>
        </div>
        <div class="kpi-card">
            <div class="kpi-value" id="avgAge">0</div>
            <div class="kpi-label">Average Age</div>
        </div>
    </div>

    <!-- Charts Section (Hidden for Reporter) -->
    <div class="charts-grid" id="chartsSection">
        <div class="chart-container">
            <div class="chart-title">Cases by District</div>
            <canvas id="districtChart" class="chart-canvas"></canvas>
        </div>
        
        <div class="chart-container">
            <div class="chart-title">Crime Types Distribution</div>
            <canvas id="crimeChart" class="chart-canvas"></canvas>
        </div>
        
        <div class="chart-container">
            <div class="chart-title">Age Distribution</div>
            <canvas id="ageChart" class="chart-canvas"></canvas>
        </div>
        
        <div class="chart-container">
            <div class="chart-title">Gender Distribution</div>
            <canvas id="genderChart" class="chart-canvas"></canvas>
        </div>
        
        <div class="chart-container">
            <div class="chart-title">Cases Over Time</div>
            <canvas id="timeChart" class="chart-canvas"></canvas>
        </div>
        
        <div class="chart-container">
            <div class="chart-title">Services Rendered Distribution</div>
            <canvas id="servicesChart" class="chart-canvas"></canvas>
        </div>
        
        <div class="chart-container">
            <div class="chart-title">Relationship Analysis</div>
            <canvas id="relationshipChart" class="chart-canvas"></canvas>
        </div>
    </div>

    <!-- Table Section (Hidden for Reporter) -->
    <div class="table-container full-width" id="tableSection">
        <div class="chart-title">Case Details</div>
        <div class="table-wrapper">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Case ID</th>
                        <th>Type</th>
                        <th>Date</th>
                        <th>District</th>
                        <th>Gender</th>
                        <th>Age</th>
                        <th>Crime Type</th>
                        <th>Disability</th>
                        <th>Services</th>
                        <th>Relationship</th>
                    </tr>
                </thead>
                <tbody id="caseTableBody">
                    <tr>
                        <td colspan="10" class="loading">
                            <div class="spinner"></div>
                            Loading case data...
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Reporter-only Content -->
    <div id="reporterOnlyContent" class="hidden">
        <div class="access-denied">
            <h2>üìù Reporter Dashboard</h2>
            <p>Welcome! You have access to add new case records and search existing cases.</p>
            <p><strong>Step 1:</strong> Select your reporting agency above</p>
            <p><strong>Step 2:</strong> Click "Add New Record" to report a new case or "Search Case" to find existing cases</p>
            <br>
            <div style="background: #e3f2fd; padding: 15px; border-radius: 8px; border-left: 4px solid #2196f3;">
                <strong>üîç Inter-Agency Collaboration:</strong><br>
                ‚Ä¢ <strong>Search Cases:</strong> Find cases from any agency (NPA, MOH, ZP)<br>
                ‚Ä¢ <strong>Add Services:</strong> Contribute additional services to existing cases<br>
                ‚Ä¢ <strong>Case ID Format:</strong> NPA-CV/CW, MOH-CV/CW, ZP-CV/CW
            </div>
        </div>
    </div>
</div>
</div>
<!-- Add Record Modal -->
<div id="addRecordModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 class="modal-title">‚ûï Add New Case Record</h2>
            <span class="close" onclick="closeAddRecordModal()">&times;</span>
        </div>
<div class="success-message" id="successMessage">
        ‚úÖ Record added successfully!
    </div>
    
    <div class="error-message" id="errorMessage">
        ‚ùå Please fill in all required fields.
    </div>

    <form id="addRecordForm">
        <div class="form-grid">
            <div class="form-group">
                <label for="caseId">Case ID</label>
                <input type="text" id="caseId" name="caseId" placeholder="Auto-generated based on agency and record type" readonly>
                <small style="color: #666; margin-top: 5px;">Format: [AGENCY]-[CV/CW][NUMBER] (e.g., NPA-CV1, MOH-CW5, ZP-CV12)</small>
            </div>
            
            <div class="form-group">
                <label for="recordType">Record Type *</label>
                <select id="recordType" name="recordType" required onchange="generateCaseId(); updateRelationshipLabel();">
                    <option value="">Select Type</option>
                    <option value="Victim">Victim</option>
                    <option value="Witness">Witness</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="dateReported">Date Reported *</label>
                <input type="date" id="dateReported" name="dateReported" required>
            </div>
            
            <div class="form-group">
                <label for="district">District *</label>
                <select id="district" name="district" required>
                    <option value="">Select District</option>
                    <option value="Lusaka">Lusaka</option>
                    <option value="Kitwe">Kitwe</option>
                    <option value="Solwezi">Solwezi</option>
                    <option value="Katete">Katete</option>
                    <option value="Chipata">Chipata</option>
                    <option value="Mansa">Mansa</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="cvwGender">CVW Gender *</label>
                <select id="cvwGender" name="cvwGender" required>
                    <option value="">Select Gender</option>
                    <option value="MALE">Male</option>
                    <option value="FEMALE">Female</option>
                </select>
            </div>
            
            <!-- DISABILITY RIGHT AFTER CVW GENDER -->
            <div class="form-group">
                <label for="disability">CVW Disability Status</label>
                <select id="disability" name="disability">
                    <option value="NON">None</option>
                    <option value="PHYSICAL">Physical</option>
                    <option value="MENTAL">Mental</option>
                    <option value="MENTAL+PHYSICAL">Mental + Physical</option>
                </select>
            </div>
            
            <!-- CVW AGE WITH YEARS/MONTHS -->
            <div class="form-group">
                <label for="cvwAge">CVW Age *</label>
                <div class="age-input-container">
                    <input type="number" id="cvwAge" name="cvwAge" min="0" max="120" placeholder="Enter age" required>
                    <select id="ageUnit" name="ageUnit" required>
                        <option value="">Select Unit</option>
                        <option value="years">Years</option>
                        <option value="months">Months</option>
                    </select>
                </div>
                <small class="age-help-text">
                    üí° Select <strong>months</strong> for infants under 1 year, <strong>years</strong> for children 1+ years old
                </small>
            </div>
            
            <!-- SERVICES RENDERED RIGHT AFTER CVW AGE -->
            <div class="form-group">
                <label for="servicesRendered">Services Rendered</label>
                <select id="servicesRendered" name="servicesRendered">
                    <option value="">Select Services</option>
                    <option value="MEDICAL REPORT">Medical Report</option>
                    <option value="COUNSELLING">Counselling</option>
                    <option value="MEDICAL + COUNSELLING">Medical + Counselling</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="offenderGender">Offender Gender</label>
                <select id="offenderGender" name="offenderGender">
                    <option value="">Select Gender</option>
                    <option value="MALE">Male</option>
                    <option value="FEMALE">Female</option>
                </select>
            </div>
            
            <!-- CRIME TYPE RIGHT AFTER OFFENDER GENDER -->
            <div class="form-group">
                <label for="crimeType">Crime Type *</label>
                <select id="crimeType" name="crimeType" required>
                    <option value="">Select Crime Type</option>
                    <option value="ASSAULT ON A CHILD">Assault on a Child</option>
                    <option value="PHYSICAL ABUSE">Physical Abuse</option>
                    <option value="SEXUAL ASSAULT">Sexual Assault</option>
                    <option value="RAPE">Rape</option>
                    <option value="CHILD NEGLECT">Child Neglect</option>
                    <option value="DEFILEMENT">Defilement</option>
                    <option value="ONLINE SEXUAL EXPLOITATION">Online Sexual Exploitation</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="offenderAge">Offender Age</label>
                <input type="number" id="offenderAge" name="offenderAge" min="0" placeholder="Offender Age">
            </div>
            
            <!-- DYNAMIC RELATIONSHIP FIELD RIGHT AFTER OFFENDER AGE -->
            <div class="form-group">
                <label for="relationshipToCv" id="relationshipLabel">Relationship to Child</label>
                <select id="relationshipToCv" name="relationshipToCv">
                    <option value="">Select Relationship</option>
                    <option value="STRANGER">Stranger</option>
                    <option value="FRIEND">Friend</option>
                    <option value="FATHER">Father</option>
                    <option value="MOTHER">Mother</option>
                    <option value="LANDLORD">Landlord</option>
                    <option value="NEIGHBOR">Neighbor</option>
                    <option value="RELATIVE">Relative</option>
                    <option value="TEACHER">Teacher</option>
                    <option value="CAREGIVER">Caregiver</option>
                </select>
            </div>
        </div>
        
        <div class="form-actions">
            <button type="button" class="cancel-btn" onclick="closeAddRecordModal()">Cancel</button>
            <button type="submit" class="submit-btn">Add Record</button>
        </div>
    </form>
</div>
</div>
<!-- Search Case Modal -->
<div id="searchCaseModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 class="modal-title">üîç Search Case by ID</h2>
            <span class="close" onclick="closeSearchCaseModal()">&times;</span>
        </div>
<div class="success-message" id="searchSuccessMessage">
        ‚úÖ Case found successfully!
    </div>
    
    <div class="error-message" id="searchErrorMessage">
        ‚ùå Case not found.
    </div>

    <!-- Search Form -->
    <div style="margin-bottom: 30px;">
        <div class="form-group">
            <label for="searchCaseId">Enter Case ID</label>
            <div style="display: flex; gap: 10px; align-items: center;">
                <input type="text" id="searchCaseId" placeholder="e.g., NPA-CV1, MOH-CW5, ZP-CV12" style="flex: 1; padding: 12px; border: 2px solid #dee2e6; border-radius: 8px; font-size: 16px;">
                <button onclick="searchCase()" style="padding: 12px 20px; background: linear-gradient(135deg, #17a2b8, #6f42c1); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">üîç Search</button>
            </div>
            <small style="color: #666; margin-top: 5px;">Format: [AGENCY]-[CV/CW][NUMBER] - Search cases from any agency</small>
        </div>
    </div>

    <!-- Case Details Display -->
    <div id="caseDetailsSection" class="hidden">
        <h3 style="color: #2c3e50; margin-bottom: 20px; border-bottom: 2px solid #ecf0f1; padding-bottom: 10px;">üìã Case Details</h3>
        
        <div class="form-grid">
            <div class="form-group">
                <label>Case ID</label>
                <input type="text" id="foundCaseId" readonly style="background: #f8f9fa; border: 1px solid #dee2e6; padding: 12px; border-radius: 8px;">
            </div>
            <div class="form-group">
                <label>Reporting Agency</label>
                <input type="text" id="foundReportingAgency" readonly style="background: #f8f9fa; border: 1px solid #dee2e6; padding: 12px; border-radius: 8px;">
            </div>
            <div class="form-group">
                <label>Record Type</label>
                <input type="text" id="foundRecordType" readonly style="background: #f8f9fa; border: 1px solid #dee2e6; padding: 12px; border-radius: 8px;">
            </div>
            <div class="form-group">
                <label>Date Reported</label>
                <input type="text" id="foundDateReported" readonly style="background: #f8f9fa; border: 1px solid #dee2e6; padding: 12px; border-radius: 8px;">
            </div>
            <div class="form-group">
                <label>District</label>
                <input type="text" id="foundDistrict" readonly style="background: #f8f9fa; border: 1px solid #dee2e6; padding: 12px; border-radius: 8px;">
            </div>
            <div class="form-group">
                <label>CVW Gender</label>
                <input type="text" id="foundCvwGender" readonly style="background: #f8f9fa; border: 1px solid #dee2e6; padding: 12px; border-radius: 8px;">
            </div>
            <div class="form-group">
                <label>CVW Age</label>
                <input type="text" id="foundCvwAge" readonly style="background: #f8f9fa; border: 1px solid #dee2e6; padding: 12px; border-radius: 8px;">
            </div>
            <div class="form-group">
                <label>Crime Type</label>
                <input type="text" id="foundCrimeType" readonly style="background: #f8f9fa; border: 1px solid #dee2e6; padding: 12px; border-radius: 8px;">
            </div>
            <div class="form-group">
                <label>Disability</label>
                <input type="text" id="foundDisability" readonly style="background: #f8f9fa; border: 1px solid #dee2e6; padding: 12px; border-radius: 8px;">
            </div>
            <div class="form-group full-width">
                <label>Current Services Rendered</label>
                <textarea id="foundServicesRendered" readonly style="background: #f8f9fa; border: 1px solid #dee2e6; padding: 12px; border-radius: 8px; min-height: 100px; resize: vertical;"></textarea>
                <small style="color: #666; margin-top: 5px;">This shows all services provided by different agencies</small>
            </div>
        </div>

        <!-- Add Service Section -->
        <div style="margin-top: 30px; padding: 25px; background: linear-gradient(135deg, #e3f2fd, #f3e5f5); border-radius: 15px; border: 2px solid #2196f3;">
            <h4 style="color: #1976d2; margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                ‚ûï Add Service by Your Agency
                <span id="currentAgencyBadge" style="background: #1976d2; color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.8rem;"></span>
            </h4>
            <p style="color: #1565c0; margin-bottom: 20px; line-height: 1.4;">
                <strong>Inter-Agency Collaboration:</strong> Add additional services that your agency has provided to this case. 
                This will be tracked with your agency name and date.
            </p>
            
            <div class="form-grid">
                <div class="form-group">
                    <label for="additionalService">Service Provided by Your Agency *</label>
                    <select id="additionalService" style="padding: 12px; border: 2px solid #dee2e6; border-radius: 8px; font-size: 16px;">
                        <option value="">Select Service</option>
                        <option value="MEDICAL REPORT">Medical Report</option>
                        <option value="COUNSELLING">Counselling</option>
                        <option value="MEDICAL + COUNSELLING">Medical + Counselling</option>
                        <option value="LEGAL SUPPORT">Legal Support</option>
                        <option value="PSYCHOSOCIAL SUPPORT">Psychosocial Support</option>
                        <option value="SAFE HOUSE PLACEMENT">Safe House Placement</option>
                        <option value="FAMILY MEDIATION">Family Mediation</option>
                        <option value="COURT PREPARATION">Court Preparation</option>
                        <option value="FOLLOW-UP VISIT">Follow-up Visit</option>
                        <option value="CHILD PROTECTION SERVICES">Child Protection Services</option>
                        <option value="EMERGENCY ACCOMMODATION">Emergency Accommodation</option>
                        <option value="EDUCATIONAL SUPPORT">Educational Support</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="serviceDate">Date Service Provided *</label>
                    <input type="date" id="serviceDate" style="padding: 12px; border: 2px solid #dee2e6; border-radius: 8px; font-size: 16px;">
                </div>
            </div>

            <div class="form-group">
                <label for="serviceNotes">Service Notes (Optional)</label>
                <textarea id="serviceNotes" placeholder="Additional details about the service provided..." style="padding: 12px; border: 2px solid #dee2e6; border-radius: 8px; min-height: 80px; resize: vertical; font-size: 16px;"></textarea>
            </div>
            
            <button onclick="addServiceToCase()" style="padding: 15px 30px; background: linear-gradient(135deg, #10b981, #059669); color: white; border: none; border-radius: 10px; cursor: pointer; font-weight: 600; font-size: 16px; margin-top: 15px; display: flex; align-items: center; gap: 8px; min-height: 50px;">
                ‚úÖ Add Service to Case
            </button>
            
            <div style="margin-top: 15px; padding: 15px; background: rgba(255, 255, 255, 0.7); border-radius: 8px; border-left: 4px solid #ff9800;">
                <strong>üìã Service Tracking Format:</strong><br>
                <small style="color: #666;">Your service will be added as: "<em>[SERVICE] ([YOUR_AGENCY] - [DATE]) [Notes if provided]</em>"</small>
            </div>
        </div>
    </div>
    
    <div class="form-actions">
        <button type="button" class="cancel-btn" onclick="closeSearchCaseModal()">Close</button>
    </div>
</div>
</div></parameter>
</invoke>
</artifacts>
<artifacts>
<invoke name="artifacts">
<parameter name="command">update</parameter>
<parameter name="id">cvw_dashboard_complete_final</parameter>
<parameter name="old_str">        // Enable add record button
        document.getElementById('addRecordBtn').disabled = false;
// Update button text to show selected agency
    const agencyNames = {
        'NPA': 'National Prosecution Authority',
        'MOH': 'Ministry of Health', 
        'ZP': 'Zambia Police'
    };
    document.getElementById('addRecordBtn').innerHTML = `‚ûï Add New Record (${agencyNames[agency]})`;
    
    console.log(`üìã Selected agency: ${agency} - ${agencyNames[agency]}`);</parameter>
<parameter name="new_str">        // Enable add record and search buttons
document.getElementById('addRecordBtn').disabled = false;
document.getElementById('searchCaseBtn').disabled = false;
// Update button text to show selected agency
    const agencyNames = {
        'NPA': 'National Prosecution Authority',
        'MOH': 'Ministry of Health', 
        'ZP': 'Zambia Police'
    };
    document.getElementById('addRecordBtn').innerHTML = `‚ûï Add New Record (${agencyNames[agency]})`;
    document.getElementById('searchCaseBtn').innerHTML = `üîç Search Case (${agencyNames[agency]})`;
    
    console.log(`üìã Selected agency: ${agency} - ${agencyNames[agency]}`);</parameter>
</invoke>
</artifacts>
<artifacts>
<invoke name="artifacts">
<parameter name="command">update</parameter>
<parameter name="id">cvw_dashboard_complete_final</parameter>
<parameter name="old_str">        // Reset agency selection and button state
        selectedAgency = null;
        document.getElementById('addRecordBtn').disabled = true;
        document.querySelectorAll('.agency-btn').forEach(btn => btn.classList.remove('selected'));</parameter>
<parameter name="new_str">        // Reset agency selection and button state
        selectedAgency = null;
        document.getElementById('addRecordBtn').disabled = true;
        document.getElementById('searchCaseBtn').disabled = true;
        document.querySelectorAll('.agency-btn').forEach(btn => btn.classList.remove('selected'));</parameter>
</invoke>
</artifacts>
<artifacts>
<invoke name="artifacts">
<parameter name="command">update</parameter>
<parameter name="id">cvw_dashboard_complete_final</parameter>
<parameter name="old_str">    // Close modal when clicking outside
    window.onclick = function(event) {
        const modal = document.getElementById('addRecordModal');
        if (event.target == modal) {
            closeAddRecordModal();
        }
    }</parameter>
<parameter name="new_str">    // Search Case Functions
    function openSearchCaseModal() {
        // Check if agency is selected
        if (!selectedAgency) {
            alert('‚ö†Ô∏è Please select a reporting agency first.');
            return;
        }
console.log('üîç Opening search case modal for agency:', selectedAgency);
    
    document.getElementById('searchCaseModal').style.display = 'block';
    document.getElementById('searchCaseId').value = '';
    document.getElementById('caseDetailsSection').classList.add('hidden');
    document.getElementById('serviceDate').value = new Date().toISOString().split('T')[0];
    
    // Update current agency badge
    const agencyNames = {
        'NPA': 'National Prosecution Authority',
        'MOH': 'Ministry of Health', 
        'ZP': 'Zambia Police'
    };
    document.getElementById('currentAgencyBadge').textContent = `${selectedAgency} - ${agencyNames[selectedAgency]}`;
    
    hideSearchMessages();
    
    // Mobile-specific adjustments
    if (window.innerWidth <= 768) {
        document.body.style.overflow = 'hidden';
        const modal = document.getElementById('searchCaseModal');
        modal.style.position = 'fixed';
        modal.style.top = '0';
        modal.style.left = '0';
        modal.style.width = '100%';
        modal.style.height = '100%';
        modal.style.zIndex = '9999';
    }
}

function closeSearchCaseModal() {
    console.log('üîç
<artifacts>
<invoke name="artifacts">
<parameter name="command">update</parameter>
<parameter name="id">cvw_dashboard_complete_final</parameter>
<parameter name="old_str">    function closeSearchCaseModal() {
        console.log('üîç </parameter>
<parameter name="new_str">    function closeSearchCaseModal() {
        console.log('üîç Closing search case modal');
document.getElementById('searchCaseModal').style.display = 'none';
    document.getElementById('caseDetailsSection').classList.add('hidden');
    hideSearchMessages();
    
    // Reset mobile-specific adjustments
    if (window.innerWidth <= 768) {
        document.body.style.overflow = 'auto';
    }
}

function searchCase() {
    const caseId = document.getElementById('searchCaseId').value.trim().toUpperCase();
    
    if (!caseId) {
        showSearchErrorMessage('Please enter a Case ID');
        return;
    }
    
    console.log('üîç Searching for case:', caseId);
    
    // Search in allData for the case
    const foundCase = allData.find(record => record['cvw code'].toUpperCase() === caseId);
    
    if (foundCase) {
        console.log('‚úÖ Case found:', foundCase);
        displayCaseDetails(foundCase);
        showSearchSuccessMessage(`Case ${caseId} found! You can now add services provided by your agency.`);
    } else {
        console.log('‚ùå Case not found:', caseId);
        document.getElementById('caseDetailsSection').classList.add('hidden');
        showSearchErrorMessage(`Case ${caseId} not found in the system. Please verify the Case ID format (e.g., NPA-CV1, MOH-CW5, ZP-CV12).`);
    }
}

function displayCaseDetails(caseData) {
    // Extract reporting agency from case ID
    const reportingAgency = caseData['cvw code'].split('-')[0];
    const agencyNames = {
        'NPA': 'National Prosecution Authority',
        'MOH': 'Ministry of Health', 
        'ZP': 'Zambia Police'
    };
    
    document.getElementById('foundCaseId').value = caseData['cvw code'];
    document.getElementById('foundReportingAgency').value = `${reportingAgency} - ${agencyNames[reportingAgency] || 'Unknown Agency'}`;
    document.getElementById('foundRecordType').value = caseData['Record Type'];
    document.getElementById('foundDateReported').value = caseData['Date Reported'].toLocaleDateString();
    document.getElementById('foundDistrict').value = caseData['District'];
    document.getElementById('foundCvwGender').value = caseData['CVW Gender'];
    document.getElementById('foundCvwAge').value = formatAgeDisplay(caseData['CVW Age']);
    document.getElementById('foundCrimeType').value = caseData['Crime Type'];
    document.getElementById('foundDisability').value = caseData['Disability'] || 'NON';
    
    // Display services with better formatting
    const currentServices = caseData['Services Rendered'] || 'No services recorded yet';
    document.getElementById('foundServicesRendered').value = currentServices;
    
    // Clear additional service form
    document.getElementById('additionalService').value = '';
    document.getElementById('serviceNotes').value = '';
    
    document.getElementById('caseDetailsSection').classList.remove('hidden');
    
    // Scroll to case details
    document.getElementById('caseDetailsSection').scrollIntoView({ behavior: 'smooth', block: 'start' });
}

function addServiceToCase() {
    const caseId = document.getElementById('foundCaseId').value;
    const additionalService = document.getElementById('additionalService').value;
    const serviceDate = document.getElementById('serviceDate').value;
    const serviceNotes = document.getElementById('serviceNotes').value.trim();
    
    if (!additionalService) {
        showSearchErrorMessage('Please select a service that your agency provided');
        return;
    }
    
    if (!serviceDate) {
        showSearchErrorMessage('Please enter the date when the service was provided');
        return;
    }
    
    // Check if service date is not in the future
    const today = new Date().toISOString().split('T')[0];
    if (serviceDate > today) {
        showSearchErrorMessage('Service date cannot be in the future');
        return;
    }
    
    console.log('‚ûï Adding service to case:', caseId, 'Service:', additionalService, 'by', selectedAgency);
    
    // Find the case in allData
    const caseIndex = allData.findIndex(record => record['cvw code'] === caseId);
    
    if (caseIndex !== -1) {
        const currentServices = allData[caseIndex]['Services Rendered'] || '';
        const agencyPrefix = selectedAgency;
        
        // Create service entry with agency, date, and notes
        let newServiceEntry = `${additionalService} (${agencyPrefix} - ${new Date(serviceDate).toLocaleDateString()})`;
        if (serviceNotes) {
            newServiceEntry += ` [${serviceNotes}]`;
        }
        
        // Update services rendered
        let updatedServices;
        if (currentServices && currentServices !== 'No services recorded yet' && currentServices !== 'No services recorded') {
            updatedServices = `${currentServices} + ${newServiceEntry}`;
        } else {
            updatedServices = newServiceEntry;
        }
        
        // Update the case data
        allData[caseIndex]['Services Rendered'] = updatedServices;
        
        // Update the display
        document.getElementById('foundServicesRendered').value = updatedServices;
        
        // Save to localStorage
        saveDataToLocalStorage();
        
        // Update dashboard if visible
        if (currentUser && (currentUser.role === 'admin' || currentUser.role === 'viewer')) {
            updateFilters();
            updateDashboard();
        }
        
        const agencyNames = {
            'NPA': 'National Prosecution Authority',
            'MOH': 'Ministry of Health', 
            'ZP': 'Zambia Police'
        };
        
        showSearchSuccessMessage(`‚úÖ Service "${additionalService}" successfully added to case ${caseId} by ${agencyNames[selectedAgency]} (${selectedAgency})`);
        
        // Clear the form
        document.getElementById('additionalService').value = '';
        document.getElementById('serviceNotes').value = '';
        
        console.log('‚úÖ Inter-agency service collaboration recorded successfully');
    } else {
        showSearchErrorMessage('Error: Case not found in database. Please try searching again.');
    }
}

function showSearchSuccessMessage(message) {
    const successMsg = document.getElementById('searchSuccessMessage');
    successMsg.textContent = message;
    successMsg.style.display = 'block';
    document.getElementById('searchErrorMessage').style.display = 'none';
    setTimeout(() => {
        successMsg.style.display = 'none';
    }, 6000);
}

function showSearchErrorMessage(message) {
    const errorMsg = document.getElementById('searchErrorMessage');
    errorMsg.textContent = message;
    errorMsg.style.display = 'block';
    document.getElementById('searchSuccessMessage').style.display = 'none';
    setTimeout(() => {
        errorMsg.style.display = 'none';
    }, 6000);
}

function hideSearchMessages() {
    document.getElementById('searchSuccessMessage').style.display = 'none';
    document.getElementById('searchErrorMessage').style.display = 'none';
}

// Close modal when clicking outside
window.onclick = function(event) {
    const addModal = document.getElementById('addRecordModal');
    const searchModal = document.getElementById('searchCaseModal');
    
    if (event.target == addModal) {
        closeAddRecordModal();
    }
    if (event.target == searchModal) {
        closeSearchCaseModal();
    }
}</parameter>
</invoke>
</artifacts>
