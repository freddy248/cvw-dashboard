<artifacts>
<invoke name="artifacts">
<parameter name="command">rewrite</parameter>
<parameter name="type">text/html</parameter>
<parameter name="title">CVW Dashboard - Fully Analyzed and Fixed Complete System</parameter>
<parameter name="id">cvw_fully_fixed_complete</parameter>
<parameter name="content"><!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Zambia Child Victim & Witness Analytics Dashboard - Inter-agency collaboration system">
    <meta http-equiv="x-content-type-options" content="nosniff">
    <meta http-equiv="cache-control" content="max-age=31536000, immutable">
    <title>CVW Case Reports Analytics Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.js" integrity="sha512-6HrPqAvK+lZElIZ4mZ64fyxIBTsaX5zAFZg2V/2WT+iKPrFzTzvx6QAsLW2OaLwobhMYBog/+bvmIEEGXi0p1w==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
    }

    .sr-only {
        position: absolute;
        width: 1px;
        height: 1px;
        padding: 0;
        margin: -1px;
        overflow: hidden;
        clip: rect(0, 0, 0, 0);
        white-space: nowrap;
        border: 0;
    }

    .login-container {
        max-width: 400px;
        margin: 10% auto;
        background: rgba(255, 255, 255, 0.95);
        border-radius: 20px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        padding: 40px;
        text-align: center;
    }

    .login-header {
        margin-bottom: 30px;
    }

    .login-header h1 {
        color: #2c3e50;
        font-size: 2rem;
        margin-bottom: 10px;
    }

    .login-header p {
        color: #7f8c8d;
        font-size: 1rem;
    }

    .login-form {
        margin-bottom: 30px;
    }

    .login-input {
        width: 100%;
        padding: 15px;
        margin-bottom: 15px;
        border: 2px solid #dee2e6;
        border-radius: 10px;
        font-size: 16px;
        transition: all 0.3s ease;
    }

    .login-input:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .login-btn {
        width: 100%;
        padding: 15px;
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white;
        border: none;
        border-radius: 10px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .login-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
    }

    .demo-accounts {
        background: #f8f9fa;
        border-radius: 10px;
        padding: 20px;
        margin-top: 20px;
    }

    .demo-accounts h3 {
        color: #2c3e50;
        margin-bottom: 15px;
        font-size: 1.1rem;
    }

    .account-demo {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
        padding: 8px;
        background: white;
        border-radius: 5px;
        font-size: 0.9rem;
    }

    .account-type {
        font-weight: 600;
        color: #495057;
    }

    .account-credentials {
        color: #6c757d;
        font-family: monospace;
    }

    .login-error {
        background: #fee2e2;
        color: #dc2626;
        padding: 10px;
        border-radius: 8px;
        margin-bottom: 15px;
        display: none;
    }

    .user-info-bar {
        background: rgba(255, 255, 255, 0.9);
        padding: 10px 20px;
        border-radius: 10px;
        margin-bottom: 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
    }

    .user-details {
        display: flex;
        align-items: center;
        gap: 15px;
    }

    .user-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: linear-gradient(135deg, #667eea, #764ba2);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: bold;
        font-size: 1.2rem;
    }

    .user-info {
        display: flex;
        flex-direction: column;
    }

    .user-name {
        font-weight: 600;
        color: #2c3e50;
    }

    .user-role {
        font-size: 0.8rem;
        color: #7f8c8d;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .logout-btn {
        padding: 8px 16px;
        background: #dc3545;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 0.9rem;
        transition: all 0.3s ease;
    }

    .logout-btn:hover {
        background: #c82333;
    }

    .role-admin .user-avatar { 
        background: linear-gradient(135deg, #28a745, #20c997); 
    }
    
    .role-viewer .user-avatar { 
        background: linear-gradient(135deg, #17a2b8, #6f42c1); 
    }
    
    .role-reporter .user-avatar { 
        background: linear-gradient(135deg, #ffc107, #fd7e14); 
    }

    .agency-btn {
        background: white;
        border: 3px solid #dee2e6;
        border-radius: 15px;
        padding: 20px;
        min-width: 200px;
        cursor: pointer;
        transition: all 0.3s ease;
        text-align: center;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
    }

    .agency-btn:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        border-color: #667eea;
    }

    .agency-btn.selected {
        border-color: #667eea;
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white;
    }

    .agency-btn.selected .agency-code {
        color: #fff;
        background: rgba(255, 255, 255, 0.2);
    }

    .agency-icon {
        font-size: 2rem;
        margin-bottom: 10px;
    }

    .agency-name {
        font-weight: 600;
        font-size: 1rem;
        margin-bottom: 8px;
        color: #2c3e50;
    }

    .agency-btn.selected .agency-name {
        color: white;
    }

    .agency-code {
        font-family: 'Courier New', monospace;
        font-weight: bold;
        font-size: 0.9rem;
        background: #f8f9fa;
        color: #495057;
        padding: 4px 8px;
        border-radius: 4px;
        display: inline-block;
    }

    .dashboard-container {
        max-width: 1400px;
        margin: 0 auto;
        background: rgba(255, 255, 255, 0.95);
        border-radius: 20px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        padding: 30px;
    }

    .header {
        text-align: center;
        margin-bottom: 30px;
        padding-bottom: 20px;
        border-bottom: 3px solid #667eea;
    }

    .header h1 {
        color: #2c3e50;
        font-size: 2.5rem;
        margin-bottom: 10px;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
    }

    .header p {
        color: #7f8c8d;
        font-size: 1.1rem;
    }

    .zambia-label {
        font-family: 'Algerian', serif;
        font-size: 24px;
        font-weight: bold;
        color: #2c3e50;
        margin: 10px 0;
    }

    .connection-status {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
        margin: 15px 0;
        padding: 10px;
        border-radius: 8px;
        font-weight: 600;
        font-size: 0.9rem;
    }

    .status-connected {
        background: #d1fae5;
        color: #059669;
        border: 1px solid #10b981;
    }

    .status-disconnected {
        background: #fee2e2;
        color: #dc2626;
        border: 1px solid #ef4444;
    }

    .status-indicator {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        animation: pulse 2s infinite;
    }

    .status-connected .status-indicator {
        background: #10b981;
    }

    .status-disconnected .status-indicator {
        background: #ef4444;
    }

    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
    }

    .action-buttons {
        display: flex;
        justify-content: center;
        gap: 15px;
        margin-bottom: 30px;
    }

    .action-btn {
        padding: 12px 24px;
        border: none;
        border-radius: 10px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 14px;
        display: flex;
        align-items: center;
        gap: 8px;
        min-height: 44px;
        touch-action: manipulation;
        user-select: none;
        -webkit-user-select: none;
    }

    .action-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none !important;
        box-shadow: none !important;
    }

    .action-btn:disabled:hover {
        transform: none !important;
        box-shadow: none !important;
    }

    .add-record-btn {
        background: linear-gradient(135deg, #10b981, #059669);
        color: white;
    }

    .add-record-btn:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(16, 185, 129, 0.3);
    }

    .view-dashboard-btn {
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white;
    }

    .view-dashboard-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
    }

    .hidden { 
        display: none !important; 
    }

    .access-denied {
        text-align: center;
        padding: 50px;
        color: #dc3545;
        background: #f8f9fa;
        border-radius: 10px;
        margin: 20px 0;
    }

    .access-denied h2 {
        margin-bottom: 10px;
    }

    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(5px);
        -webkit-backdrop-filter: blur(5px);
    }

    .modal-content {
        background: white;
        margin: 2% auto;
        padding: 30px;
        border-radius: 20px;
        width: 90%;
        max-width: 800px;
        max-height: 90vh;
        overflow-y: auto;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
    }

    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 25px;
        padding-bottom: 15px;
        border-bottom: 2px solid #ecf0f1;
    }

    .modal-title {
        font-size: 1.5rem;
        font-weight: 600;
        color: #2c3e50;
    }

    .close {
        color: #95a5a6;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
        transition: color 0.3s ease;
        background: none;
        border: none;
    }

    .close:hover {
        color: #e74c3c;
    }

    .form-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
    }

    .form-group {
        display: flex;
        flex-direction: column;
    }

    .form-group label {
        font-weight: 600;
        color: #495057;
        margin-bottom: 8px;
        font-size: 0.9rem;
    }

    .form-group input,
    .form-group select,
    .form-group textarea {
        padding: 12px 15px;
        border: 2px solid #dee2e6;
        border-radius: 8px;
        background: white;
        font-size: 14px;
        transition: all 0.3s ease;
        user-select: text;
        -webkit-user-select: text;
    }

    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .full-width {
        grid-column: 1 / -1;
    }

    .form-actions {
        display: flex;
        justify-content: flex-end;
        gap: 15px;
        margin-top: 30px;
        padding-top: 20px;
        border-top: 2px solid #ecf0f1;
    }

    .cancel-btn {
        padding: 12px 24px;
        background: #95a5a6;
        color: white;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.3s ease;
        min-height: 44px;
    }

    .cancel-btn:hover {
        background: #7f8c8d;
    }

    .submit-btn {
        padding: 12px 24px;
        background: linear-gradient(135deg, #10b981, #059669);
        color: white;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.3s ease;
        min-height: 44px;
    }

    .submit-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(16, 185, 129, 0.3);
    }

    .filters-section {
        background: linear-gradient(135deg, #f8f9fa, #e9ecef);
        padding: 20px;
        border-radius: 15px;
        margin-bottom: 30px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
    }

    .filters-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        align-items: end;
    }

    .filter-group {
        display: flex;
        flex-direction: column;
    }

    .filter-group label {
        font-weight: 600;
        color: #495057;
        margin-bottom: 5px;
        font-size: 0.9rem;
    }

    .filter-group select,
    .date-input {
        padding: 10px 15px;
        border: 2px solid #dee2e6;
        border-radius: 8px;
        background: white;
        font-size: 14px;
        transition: all 0.3s ease;
    }

    .filter-group select:focus,
    .date-input:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .reset-btn {
        padding: 10px 20px;
        background: linear-gradient(135deg, #ff6b6b, #ee5a52);
        color: white;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.3s ease;
        height: fit-content;
        min-height: 44px;
    }

    .reset-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(238, 90, 82, 0.3);
    }

    .kpi-section {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }

    .kpi-card {
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white;
        padding: 25px;
        border-radius: 15px;
        text-align: center;
        box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
        transition: all 0.3s ease;
    }

    .kpi-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 15px 40px rgba(102, 126, 234, 0.4);
    }

    .kpi-value {
        font-size: 2.5rem;
        font-weight: 700;
        margin-bottom: 5px;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
    }

    .kpi-label {
        font-size: 1rem;
        opacity: 0.9;
        font-weight: 500;
    }

    .table-container {
        background: white;
        border-radius: 15px;
        padding: 25px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        overflow: hidden;
    }

    .data-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.9rem;
    }

    .data-table th {
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white;
        padding: 15px 10px;
        text-align: left;
        font-weight: 600;
        position: sticky;
        top: 0;
        z-index: 10;
    }

    .data-table td {
        padding: 12px 10px;
        border-bottom: 1px solid #ecf0f1;
        transition: background-color 0.2s ease;
    }

    .data-table tr:hover td {
        background-color: #f8f9fa;
    }

    .table-wrapper {
        max-height: 400px;
        overflow-y: auto;
        border-radius: 10px;
        border: 1px solid #dee2e6;
        scrollbar-width: thin;
        scrollbar-color: #667eea #f1f1f1;
    }

    .table-wrapper::-webkit-scrollbar {
        width: 8px;
    }

    .table-wrapper::-webkit-scrollbar-track {
        background: #f1f1f1;
    }

    .table-wrapper::-webkit-scrollbar-thumb {
        background: #667eea;
        border-radius: 4px;
    }

    .loading {
        display: flex;
        justify-content: center;
        align-items: center;
        height: 200px;
        font-size: 1.2rem;
        color: #667eea;
    }

    .spinner {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #667eea;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin-right: 15px;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    .status-badge {
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 0.8rem;
        font-weight: 600;
        text-transform: uppercase;
    }

    .victim-badge { 
        background: #fee2e2; 
        color: #dc2626; 
    }
    
    .witness-badge { 
        background: #dbeafe; 
        color: #2563eb; 
    }

    .success-message {
        background: #d1fae5;
        color: #059669;
        padding: 12px 20px;
        border-radius: 8px;
        margin-bottom: 20px;
        border-left: 4px solid #10b981;
        display: none;
    }

    .error-message {
        background: #fee2e2;
        color: #dc2626;
        padding: 12px 20px;
        border-radius: 8px;
        margin-bottom: 20px;
        border-left: 4px solid #ef4444;
        display: none;
    }

    .age-input-container {
        display: flex;
        gap: 10px;
        align-items: center;
    }

    .age-input-container input {
        flex: 2;
    }

    .age-input-container select {
        flex: 1;
    }

    .age-display {
        font-weight: 500;
        padding: 2px 6px;
        border-radius: 4px;
        white-space: nowrap;
    }

    .age-display.infant {
        background-color: #fee2e2;
        color: #dc2626;
        font-weight: 600;
    }

    .age-display.toddler {
        background-color: #fed7aa;
        color: #ea580c;
        font-weight: 600;
    }

    .age-display.child {
        background-color: #dcfce7;
        color: #059669;
    }

    .age-display.teen {
        background-color: #dbeafe;
        color: #2563eb;
    }

    .age-help-text {
        color: #666;
        font-size: 0.8rem;
        margin-top: 5px;
        font-style: italic;
    }

    @media (max-width: 768px) {
        .dashboard-container {
            padding: 15px;
        }
        
        .header h1 {
            font-size: 2rem;
        }
        
        .filters-grid {
            grid-template-columns: 1fr;
        }

        .form-grid {
            grid-template-columns: 1fr;
        }

        .modal-content {
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 15px;
            border-radius: 0;
            max-height: 100vh;
            overflow-y: auto;
        }

        .modal {
            padding: 0;
        }

        .action-buttons {
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }

        .action-btn {
            width: 90%;
            max-width: 300px;
            padding: 15px;
            font-size: 16px;
        }

        .age-input-container {
            flex-direction: column;
            gap: 8px;
        }

        .age-input-container input,
        .age-input-container select {
            flex: none;
            width: 100%;
            padding: 15px;
            font-size: 16px;
        }

        .form-group input,
        .form-group select {
            padding: 15px;
            font-size: 16px;
            border-radius: 8px;
        }

        .user-info-bar {
            flex-direction: column;
            gap: 10px;
            text-align: center;
        }

        #agencySelection {
            margin-bottom: 10px;
        }

        #agencySelection > div {
            flex-direction: column;
            gap: 10px;
        }

        .agency-btn {
            min-width: auto;
            width: 100%;
            padding: 25px 15px;
            font-size: 14px;
        }

        .login-container {
            margin: 5% auto;
            width: 95%;
            padding: 30px 20px;
        }

        .submit-btn, .cancel-btn {
            padding: 15px 25px;
            font-size: 16px;
            min-height: 50px;
        }

        .form-group label {
            font-size: 16px;
            margin-bottom: 10px;
        }

        .modal-title {
            font-size: 1.3rem;
            line-height: 1.4;
        }

        button, .action-btn, .agency-btn {
            min-height: 44px;
            touch-action: manipulation;
        }

        input, select, textarea {
            font-size: 16px !important;
            transform-origin: left top;
        }
    }
</style>
</head>
<body>
    <!-- Login Screen -->
    <div id="loginScreen" class="login-container">
        <div class="login-header">
            <h1>🔐 CVW Dashboard</h1>
            <p>Zambia Child Victim & Witness Analytics</p>
        </div>
<div class="login-error" id="loginError">
        ❌ Invalid username or password
    </div>
    
    <form class="login-form" id="loginForm" role="form" aria-label="Login Form">
        <label for="username" class="sr-only">Username</label>
        <input type="text" id="username" name="username" class="login-input" placeholder="Username" title="Enter your username" autocomplete="username" required aria-label="Username">
        
        <label for="password" class="sr-only">Password</label>
        <input type="password" id="password" name="password" class="login-input" placeholder="Password" title="Enter your password" autocomplete="current-password" required aria-label="Password">
        
        <button type="submit" class="login-btn" title="Submit login form" aria-label="Login to dashboard">🚀 Login</button>
    </form>
    
    <div class="demo-accounts">
        <h3>📋 Demo Accounts</h3>
        <div class="account-demo">
            <span class="account-type">👑 Admin</span>
            <span class="account-credentials">admin / admin123</span>
        </div>
        <div class="account-demo">
            <span class="account-type">👀 Viewer</span>
            <span class="account-credentials">viewer / view123</span>
        </div>
        <div class="account-demo">
            <span class="account-type">📝 Reporter</span>
            <span class="account-credentials">reporter / report123</span>
        </div>
    </div>
</div>

<!-- Main Dashboard -->
<div id="mainDashboard" class="hidden">
    <!-- User Info Bar -->
    <div id="userInfoBar" class="user-info-bar">
        <div class="user-details">
            <div id="userAvatar" class="user-avatar">A</div>
            <div class="user-info">
                <div id="userName" class="user-name">Administrator</div>
                <div id="userRole" class="user-role">Admin Account</div>
            </div>
        </div>
        <button class="logout-
<artifacts>
<invoke name="artifacts">
<parameter name="command">update</parameter>
<parameter name="id">cvw_fully_fixed_complete</parameter>
<parameter name="old_str">            <button class="logout-</parameter>
<parameter name="new_str">            <button class="logout-btn" onclick="logout()" title="Logout from dashboard" aria-label="Logout from current session">🚪 Logout</button>
        </div>
<div class="dashboard-container">
        <div class="header">
            <h1>📊 CVW Case Reports Analytics</h1>
            <p class="zambia-label">Zambia</p>
            <p>Comprehensive Analysis of Child Victim & Witness Cases</p>
            
            <!-- Database Connection Status -->
            <div id="connectionStatus" class="connection-status">
                <div class="status-indicator"></div>
                <span id="statusText">Checking database connection...</span>
            </div>
        </div>

        <!-- Reporting Agency Selection (For Admin and Reporter) -->
        <div id="agencySelection" class="filters-section hidden" style="margin-bottom: 20px;">
            <h3 style="text-align: center; color: #2c3e50; margin-bottom: 20px;">🏛️ Select Reporting Agency</h3>
            <div style="display: flex; justify-content: center; gap: 15px; flex-wrap: wrap;">
                <button class="agency-btn" data-agency="NPA" onclick="selectAgency('NPA')" title="Select National Prosecution Authority" aria-label="Select National Prosecution Authority as reporting agency">
                    <div class="agency-icon" role="img" aria-label="Scales of justice">⚖️</div>
                    <div class="agency-name">National Prosecution Authority</div>
                    <div class="agency-code">NPA</div>
                </button>
                <button class="agency-btn" data-agency="MOH" onclick="selectAgency('MOH')" title="Select Ministry of Health" aria-label="Select Ministry of Health as reporting agency">
                    <div class="agency-icon" role="img" aria-label="Hospital">🏥</div>
                    <div class="agency-name">Ministry of Health</div>
                    <div class="agency-code">MOH</div>
                </button>
                <button class="agency-btn" data-agency="ZP" onclick="selectAgency('ZP')" title="Select Zambia Police" aria-label="Select Zambia Police as reporting agency">
                    <div class="agency-icon" role="img" aria-label="Police officer">👮</div>
                    <div class="agency-name">Zambia Police</div>
                    <div class="agency-code">ZP</div>
                </button>
            </div>
        </div>

        <!-- Action Buttons (Role-based visibility) -->
        <div class="action-buttons" id="actionButtons">
            <button class="action-btn add-record-btn" id="addRecordBtn" onclick="openAddRecordModal()" disabled title="Add new case record" aria-label="Add new case record">
                <span role="img" aria-label="Plus sign">➕</span> Add New Record
            </button>
            <button class="action-btn" id="searchCaseBtn" style="background: linear-gradient(135deg, #17a2b8, #6f42c1);" onclick="openSearchCaseModal()" disabled title="Search existing cases" aria-label="Search for existing cases">
                <span role="img" aria-label="Magnifying glass">🔍</span> Search Case
            </button>
            <button class="action-btn view-dashboard-btn" id="viewDashboardBtn" onclick="showDashboardView()" title="View analytics dashboard" aria-label="View analytics dashboard">
                <span role="img" aria-label="Chart">📈</span> View Dashboard
            </button>
            <button class="action-btn" id="clearDataBtn" style="background: linear-gradient(135deg, #ff6b6b, #ee5a52);" onclick="clearAllData()" title="Clear all locally saved data" aria-label="Clear all locally saved data">
                <span role="img" aria-label="Trash can">🗑️</span> Clear Data
            </button>
        </div>

        <!-- Filters Section (Hidden for Reporter) -->
        <div class="filters-section" id="filtersSection">
            <div class="filters-grid">
                <div class="filter-group">
                    <label for="districtFilter">District</label>
                    <select id="districtFilter" title="Filter by district" aria-label="Filter cases by district">
                        <option value="">All Districts</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="recordTypeFilter">Record Type</label>
                    <select id="recordTypeFilter" title="Filter by record type" aria-label="Filter cases by record type">
                        <option value="">All Types</option>
                        <option value="Victim">Victim</option>
                        <option value="Witness">Witness</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="crimeTypeFilter">Crime Type</label>
                    <select id="crimeTypeFilter" title="Filter by crime type" aria-label="Filter cases by crime type">
                        <option value="">All Crime Types</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="genderFilter">Gender</label>
                    <select id="genderFilter" title="Filter by gender" aria-label="Filter cases by gender">
                        <option value="">All Genders</option>
                        <option value="MALE">Male</option>
                        <option value="FEMALE">Female</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="dateFromFilter">Date From</label>
                    <input type="date" id="dateFromFilter" name="dateFromFilter" class="date-input" title="Filter from date" aria-label="Filter cases from this date" autocomplete="off">
                </div>
                <div class="filter-group">
                    <label for="dateToFilter">Date To</label>
                    <input type="date" id="dateToFilter" name="dateToFilter" class="date-input" title="Filter to date" aria-label="Filter cases up to this date" autocomplete="off">
                </div>
                <div class="filter-group">
                    <label for="servicesFilter">Services Rendered</label>
                    <select id="servicesFilter" title="Filter by services rendered" aria-label="Filter cases by services rendered">
                        <option value="">All Services</option>
                    </select>
                </div>
                <div class="filter-group">
                    <button class="reset-btn" onclick="resetFilters()" title="Reset all filters" aria-label="Reset all filter selections">
                        <span role="img" aria-label="Refresh">🔄</span> Reset Filters
                    </button>
                </div>
            </div>
        </div>

        <!-- KPI Section (Hidden for Reporter) -->
        <div class="kpi-section" id="kpiSection">
            <div class="kpi-card">
                <div class="kpi-value" id="totalCases">0</div>
                <div class="kpi-label">Total Cases</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-value" id="victimCases">0</div>
                <div class="kpi-label">Victim Cases</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-value" id="witnessCases">0</div>
                <div class="kpi-label">Witness Cases</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-value" id="avgAge">0</div>
                <div class="kpi-label">Average Age</div>
            </div>
        </div>

        <!-- Table Section (Hidden for Reporter) -->
        <div class="table-container full-width" id="tableSection">
            <div class="modal-title">Case Details</div>
            <div class="table-wrapper">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Case ID</th>
                            <th>Type</th>
                            <th>Date</th>
                            <th>District</th>
                            <th>Gender</th>
                            <th>Age</th>
                            <th>Crime Type</th>
                            <th>Disability</th>
                            <th>Services</th>
                            <th>Relationship</th>
                        </tr>
                    </thead>
                    <tbody id="caseTableBody">
                        <tr>
                            <td colspan="10" class="loading">
                                <div class="spinner"></div>
                                Loading case data...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Reporter-only Content -->
        <div id="reporterOnlyContent" class="hidden">
            <div class="access-denied">
                <h2>📝 Reporter Dashboard</h2>
                <p>Welcome! You have access to add new case records and search existing cases.</p>
                <p><strong>Step 1:</strong> Select your reporting agency above</p>
                <p><strong>Step 2:</strong> Click "Add New Record" to report a new case or "Search Case" to find existing cases</p>
                <br>
                <div style="background: #e3f2fd; padding: 15px; border-radius: 8px; border-left: 4px solid #2196f3;">
                    <strong>🔍 Inter-Agency Collaboration:</strong><br>
                    • <strong>Search Cases:</strong> Find cases from any agency (NPA, MOH, ZP)<br>
                    • <strong>Add Services:</strong> Contribute additional services to existing cases<br>
                    • <strong>Case ID Format:</strong> NPA-CV/CW, MOH-CV/CW, ZP-CV/CW
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Record Modal -->
<div id="addRecordModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 class="modal-title">➕ Add New Case Record</h2>
            <button class="close" onclick="closeAddRecordModal()" title="Close add record modal" aria-label="Close add record modal">&times;</button>
        </div>
        
        <div class="success-message" id="successMessage">
            ✅ Record added successfully!
        </div>
        
        <div class="error-message" id="errorMessage">
            ❌ Please fill in all required fields.
        </div>

        <form id="addRecordForm" role="form" aria-label="Add New Case Record Form">
            <div class="form-grid">
                <div class="form-group">
                    <label for="caseId">Case ID</label>
                    <input type="text" id="caseId" name="caseId" placeholder="Auto-generated based on agency and record type" readonly title="Case ID will be auto-generated" aria-label="Case ID - automatically generated" aria-describedby="caseid-help">
                    <small id="caseid-help" style="color: #666; margin-top: 5px;">Format: [AGENCY]-[CV/CW][NUMBER] (e.g., NPA-CV1, MOH-CW5, ZP-CV12)</small>
                </div>
                
                <div class="form-group">
                    <label for="recordType">Record Type *</label>
                    <select id="recordType" name="recordType" required onchange="generateCaseId(); updateRelationshipLabel();" title="Select record type" aria-label="Select record type" aria-describedby="recordtype-help">
                        <option value="">Select Type</option>
                        <option value="Victim">Victim</option>
                        <option value="Witness">Witness</option>
                    </select>
                    <small id="recordtype-help" style="color: #666; margin-top: 5px;">Choose whether this is a victim or witness record</small>
                </div>
                
                <div class="form-group">
                    <label for="dateReported">Date Reported *</label>
                    <input type="date" id="dateReported" name="dateReported" required title="Date when case was reported" aria-label="Date when case was reported" autocomplete="off">
                </div>
                
                <div class="form-group">
                    <label for="district">District *</label>
                    <select id="district" name="district" required title="Select district where case occurred" aria-label="Select district where case occurred">
                        <option value="">Select District</option>
                        <option value="Lusaka">Lusaka</option>
                        <option value="Kitwe">Kitwe</option>
                        <option value="Solwezi">Solwezi</option>
                        <option value="Katete">Katete</option>
                        <option value="Chipata">Chipata</option>
                        <option value="Mansa">Mansa</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="cvwGender">CVW Gender *</label>
                    <select id="cvwGender" name="cvwGender" required title="Select child/victim/witness gender" aria-label="Select child victim or witness gender" autocomplete="sex">
                        <option value="">Select Gender</option>
                        <option value="MALE">Male</option>
                        <option value="FEMALE">Female</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="disability">CVW Disability Status</label>
                    <select id="disability" name="disability" title="Select disability status" aria-label="Select child disability status">
                        <option value="NON">None</option>
                        <option value="PHYSICAL">Physical</option>
                        <option value="MENTAL">Mental</option>
                        <option value="MENTAL+PHYSICAL">Mental + Physical</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="cvwAge">CVW Age *</label>
                    <div class="age-input-container">
                        <input type="number" id="cvwAge" name="cvwAge" min="0" max="120" placeholder="Enter age" required title="Enter child age" aria-label="Enter child age" autocomplete="off">
                        <select id="ageUnit" name="ageUnit" required title="Select age unit" aria-label="Select age unit - years or months">
                            <option value="">Select Unit</option>
                            <option value="years">Years</option>
                            <option value="months">Months</option>
                        </select>
                    </div>
                    <small class="age-help-text" id="age-help">
                        <span role="img" aria-label="Light bulb">💡</span> Select <strong>months</strong> for infants under 1 year, <strong>years</strong> for children 1+ years old
                    </small>
                </div>
                
                <div class="form-group">
                    <label for="servicesRendered">Services Rendered</label>
                    <select id="servicesRendered" name="servicesRendered" title="Select services provided" aria-label="Select services provided to the child">
                        <option value="">Select Services</option>
                        <option value="MEDICAL REPORT">Medical Report</option>
                        <option value="COUNSELLING">Counselling</option>
                        <option value="MEDICAL + COUNSELLING">Medical + Counselling</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="offenderGender">Offender Gender</label>
                    <select id="offenderGender" name="offenderGender" title="Select offender gender" aria-label="Select offender gender" autocomplete="off">
                        <option value="">Select Gender</option>
                        <option value="MALE">Male</option>
                        <option value="FEMALE">Female</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="crimeType">Crime Type *</label>
                    <select id="crimeType" name="crimeType" required title="Select type of crime" aria-label="Select type of crime committed">
                        <option value="">Select Crime Type</option>
                        <option value="ASSAULT ON A CHILD">Assault on a Child</option>
                        <option value="PHYSICAL ABUSE">Physical Abuse</option>
                        <option value="SEXUAL ASSAULT">Sexual Assault</option>
                        <option value="RAPE">Rape</option>
                        <option value="CHILD NEGLECT">Child Neglect</option>
                        <option value="DEFILEMENT">Defilement</option>
                        <option value="ONLINE SEXUAL EXPLOITATION">Online Sexual Exploitation</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="offenderAge">Offender Age</label>
                    <input type="number" id="offenderAge" name="offenderAge" min="0" placeholder="Offender Age" title="Enter offender age" aria-label="Enter offender age" autocomplete="off">
                </div>
                
                <div class="form-group">
                    <label for="relationshipToCv" id="relationshipLabel">Relationship to Child</label>
                    <select id="relationshipToCv" name="relationshipToCv" title="Select relationship to child" aria-label="Select offender relationship to child">
                        <option value="">Select Relationship</option>
                        <option value="STRANGER">Stranger</option>
                        <option value="FRIEND">Friend</option>
                        <option value="FATHER">Father</option>
                        <option value="MOTHER">Mother</option>
                        <option value="LANDLORD">Landlord</option>
                        <option value="NEIGHBOR">Neighbor</option>
                        <option value="RELATIVE">Relative</option>
                        <option value="TEACHER">Teacher</option>
                        <option value="CAREGIVER">Caregiver</option>
                    </select>
                </div>
            </div>
            
            <div class="form-actions">
                <button type="button" class="cancel-btn" onclick="closeAddRecordModal()" title="Cancel and close form" aria-label="Cancel form and close modal">Cancel</button>
                <button type="submit" class="submit-btn" title="Submit case record" aria-label="Submit new case record">Add Record</button>
            </div>
        </form>
    </div>
</div>

<!-- Search Case Modal -->
<div id="searchCaseModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 class="modal-title">🔍 Search Case by ID</h2>
            <button class="close" onclick="closeSearchCaseModal()" title="Close search modal" aria-label="Close search case modal">&times;</button>
        </div>
        
        <div class="success-message" id="searchSuccessMessage">
            ✅ Case found successfully!
        </div>
        
        <div class="error-message" id="searchErrorMessage">
            ❌ Case not found.
        </div>

        <!-- Search Form -->
        <div style="margin-bottom: 30px;">
            <div class="form-group">
                <label for="searchCaseId">Enter Case ID</label>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <input type="text" id="searchCaseId" name="searchCaseId" placeholder="e.g., NPA-CV1, MOH-CW5, ZP-CV12" title="Enter case ID to search" aria-label="Enter case ID to search" autocomplete="off" style="flex: 1; padding: 12px; border: 2px solid #dee2e6; border-radius: 8px; font-size: 16px;">
                    <button onclick="searchCase()" title="Search for case" aria-label="Search for case by ID" style="padding: 12px 20px; background: linear-gradient(135deg, #17a2b8, #6f42c1); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">
                        <span role="img" aria-label="Magnifying glass">🔍</span> Search
                    </button>
                </div>
                <small style="color: #666; margin-top: 5px;">Format: [AGENCY]-[CV/CW][NUMBER] - Search cases from any agency</small>
            </div>
        </div>

        <!-- Case Details Display -->
        <div id="caseDetailsSection" class="hidden">
            <h3 style="color: #2c3e50; margin-bottom: 20px; border-bottom: 2px solid #ecf0f1; padding-bottom: 10px;">📋 Case Details</h3>
            
            <div class="form-grid">
                <div class="form-group">
                    <label>Case ID</label>
                    <input type="text" id="foundCaseId" name="foundCaseId" readonly title="Case ID" aria-label="Found case ID" style="background: #f8f9fa; border: 1px solid #dee2e6; padding: 12px; border-radius: 8px;">
                </div>
                <div class="form-group">
                    <label>Reporting Agency</label>
                    <input type="text" id="foundReportingAgency" name="foundReportingAgency" readonly title="Reporting agency" aria-label="Reporting agency" style="background: #f8f9fa; border: 1px solid #dee2e6; padding: 12px; border-radius: 8px;">
                </div>
                <div class="form-group">
                    <label>Record Type</label>
                    <input type="text" id="foundRecordType" readonly style="background: #f8f9fa; border: 1px solid #dee2e6; padding: 12px; border-radius: 8px;">
                </div>
                <div class="form-group">
                    <label>Date Reported</label>
                    <input type="text" id="foundDateReported" readonly style="background: #f8f9fa; border: 1px solid #dee2e6; padding: 12px; border-radius: 8px;">
                </div>
                <div class="form-group">
                    <label>District</label>
                    <input type="text" id="foundDistrict" readonly style="background: #f8f9fa; border: 1px solid #dee2e6; padding: 12px; border-radius: 8px;">
                </div>
                <div class="form-group">
                    <label>CVW Gender</label>
                    <input type="text" id="foundCvwGender" readonly style="background: #f8f9fa; border: 1px solid #dee2e6; padding: 12px; border-radius: 8px;">
                </div>
                <div class="form-group">
                    <label>CVW Age</label>
                    <input type="text" id="foundCvwAge" readonly style="background: #f8f9fa; border: 1px solid #dee2e6; padding: 12px; border-radius: 8px;">
                </div>
                <div class="form-group">
                    <label>Crime Type</label>
                    <input type="text" id="foundCrimeType" readonly style="background: #f8f9fa; border: 1px solid #dee2e6; padding: 12px; border-radius: 8px;">
                </div>
                <div class="form-group">
                    <label>Disability</label>
                    <input type="text" id="foundDisability" readonly style="background: #f8f9fa; border: 1px solid #dee2e6; padding: 12px; border-radius: 8px;">
                </div>
                <div class="form-group full-width">
                    <label>Current Services Rendered</label>
                    <textarea id="foundServicesRendered" name="foundServicesRendered" readonly title="Services rendered by all agencies" aria-label="Services rendered by all agencies" style="background: #f8f9fa; border: 1px solid #dee2e6; padding: 12px; border-radius: 8px; min-height: 100px; resize: vertical;"></textarea>
                    <small style="color: #666; margin-top: 5px;">This shows all services provided by different agencies</small>
                </div>
            </div>

            <!-- Add Service Section -->
            <div style="margin-top: 30px; padding: 25px; background: linear-gradient(135deg, #e3f2fd, #f3e5f5); border-radius: 15px; border: 2px solid #2196f3;">
                <h4 style="color: #1976d2; margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                    ➕ Add Service by Your Agency
                    <span id="currentAgencyBadge" style="background: #1976d2; color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.8rem;"></span>
                </h4>
                <p style="color: #1565c0; margin-bottom: 20px; line-height: 1.4;">
                    <strong>Inter-Agency Collaboration:</strong> Add additional services that your agency has provided to this case. 
                    This will be tracked with your agency name and date.
                </p>
                
                <div class="form-grid">
                    <div class="form-group">
                        <label for="additionalService">Service Provided by Your Agency *</label>
                        <select id="additionalService" name="additionalService" title="Select additional service provided" aria-label="Select additional service provided by your agency" style="padding: 12px; border: 2px solid #dee2e6; border-radius: 8px; font-size: 16px;">
                            <option value="">Select Service</option>
                            <option value="MEDICAL REPORT">Medical Report</option>
                            <option value="COUNSELLING">Counselling</option>
                            <option value="MEDICAL + COUNSELLING">Medical + Counselling</option>
                            <option value="LEGAL SUPPORT">Legal Support</option>
                            <option value="PSYCHOSOCIAL SUPPORT">Psychosocial Support</option>
                            <option value="SAFE HOUSE PLACEMENT">Safe House Placement</option>
                            <option value="FAMILY MEDIATION">Family Mediation</option>
                            <option value="COURT PREPARATION">Court Preparation</option>
                            <option value="FOLLOW-UP VISIT">Follow-up Visit</option>
                            <option value="CHILD PROTECTION SERVICES">Child Protection Services</option>
                            <option value="EMERGENCY ACCOMMODATION">Emergency Accommodation</option>
                            <option value="EDUCATIONAL SUPPORT">Educational Support</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="serviceDate">Date Service Provided *</label>
                        <input type="date" id="serviceDate" name="serviceDate" title="Date service was provided" aria-label="Date service was provided" autocomplete="off" style="padding: 12px; border: 2px solid #dee2e6; border-radius: 8px; font-size: 16px;">
                    </div>
                </div>

                <div class="form-group">
                    <label for="serviceNotes">Service Notes (Optional)</label>
                    <textarea id="serviceNotes" name="serviceNotes" placeholder="Additional details about the service provided..." title="Optional notes about the service" aria-label="Optional notes about the service provided" style="padding: 12px; border: 2px solid #dee2e6; border-radius: 8px; min-height: 80px; resize: vertical; font-size: 16px;"></textarea>
                </div>
                
                <button onclick="addServiceToCase()" title="Add service to this case" aria-label="Add selected service to this case record" style="padding: 15px 30px; background: linear-gradient(135deg, #10b981, #059669); color: white; border: none; border-radius: 10px; cursor: pointer; font-weight: 600; font-size: 16px; margin-top: 15px; display: flex; align-items: center; gap: 8px; min-height: 50px;">
                    <span role="img" aria-label="Check mark">✅</span> Add Service to Case
                </button>
                
                <div style="margin-top: 15px; padding: 15px; background: rgba(255, 255, 255, 0.7); border-radius: 8px; border-left: 4px solid #ff9800;">
                    <strong>📋 Service Tracking Format:</strong><br>
                    <small style="color: #666;">Your service will be added as: "<em>[SERVICE] ([YOUR_AGENCY] - [DATE]) [Notes if provided]</em>"</small>
                </div>
            </div>
        </div>
        
        <div class="form-actions">
            <button type="button" class="cancel-btn" onclick="closeSearchCaseModal()" title="Close search modal" aria-label="Close search case modal">Close</button>
        </div>
    </div>
</div>

<script>
let allData = [];
let filteredData = [];
let charts = {};
let isConnectedToDatabase = false;
let currentUser = null;
let selectedAgency = null;

const users = {
    'admin': { 
        password: 'admin123', 
        role: 'admin', 
        name: 'Administrator',
        avatar: 'A',
        permissions: ['view', 'add', 'edit', 'delete', 'admin']
    },
    'viewer': { 
        password: 'view123', 
        role: 'viewer', 
        name: 'Data Viewer',
        avatar: 'V',
        permissions: ['view']
    },
    'reporter': { 
        password: 'report123', 
        role: 'reporter', 
        name: 'Case Reporter',
        avatar: 'R',
        permissions: ['add']
    }
};

function login(username, password) {
    console.log('🔐 Login function called for:', username);
    console.log('🔑 Available users:', Object.keys(users));
    
    const user = users[username];
    console.log('👤 Found user:', user ? 'YES' : 'NO');
    
    if (user) {
        console.log('🔒 Password check:', user.password === password ? 'MATCH'
<artifacts>
<invoke name="artifacts">
<parameter name="command">update</parameter>
<parameter name="id">cvw_fully_fixed_complete</parameter>
<parameter name="old_str">        if (user) {
            console.log('🔒 Password check:', user.password === password ? 'MATCH'</parameter>
<parameter name="new_str">        if (user) {
            console.log('🔒 Password check:', user.password === password ? 'MATCH' : 'NO MATCH');
            console.log('🔒 Expected:', user.password, 'Got:', password);
        }
if (user && user.password === password) {
        console.log('✅ Authentication successful');
        currentUser = {
            username: username,
            ...user
        };
        
        localStorage.setItem('cvw_session', JSON.stringify(currentUser));
        console.log('💾 Session saved to localStorage');
        
        updateUserInterface();
        showDashboard();
        return true;
    }
    
    console.log('❌ Authentication failed');
    return false;
}

function logout() {
    currentUser = null;
    localStorage.removeItem('cvw_session');
    showLoginScreen();
}

function checkSession() {
    const session = localStorage.getItem('cvw_session');
    if (session) {
        try {
            currentUser = JSON.parse(session);
            updateUserInterface();
            showDashboard();
            return true;
        } catch (e) {
            localStorage.removeItem('cvw_session');
        }
    }
    return false;
}

function hasPermission(permission) {
    return currentUser && currentUser.permissions.includes(permission);
}

function updateUserInterface() {
    if (!currentUser) return;

    document.getElementById('userName').textContent = currentUser.name;
    document.getElementById('userRole').textContent = `${currentUser.role.charAt(0).toUpperCase() + currentUser.role.slice(1)} Account`;
    document.getElementById('userAvatar').textContent = currentUser.avatar;
    
    const userInfoBar = document.getElementById('userInfoBar');
    userInfoBar.className = `user-info-bar role-${currentUser.role}`;

    const role = currentUser.role;
    
    if (role === 'admin') {
        document.getElementById('addRecordBtn').classList.remove('hidden');
        document.getElementById('viewDashboardBtn').classList.remove('hidden');
        document.getElementById('clearDataBtn').classList.remove('hidden');
        document.getElementById('filtersSection').classList.remove('hidden');
        document.getElementById('kpiSection').classList.remove('hidden');
        document.getElementById('tableSection').classList.remove('hidden');
        document.getElementById('reporterOnlyContent').classList.add('hidden');
        document.getElementById('agencySelection').classList.remove('hidden');
    }
    else if (role === 'viewer') {
        document.getElementById('addRecordBtn').classList.add('hidden');
        document.getElementById('viewDashboardBtn').classList.remove('hidden');
        document.getElementById('clearDataBtn').classList.add('hidden');
        document.getElementById('filtersSection').classList.remove('hidden');
        document.getElementById('kpiSection').classList.remove('hidden');
        document.getElementById('tableSection').classList.remove('hidden');
        document.getElementById('reporterOnlyContent').classList.add('hidden');
        document.getElementById('agencySelection').classList.add('hidden');
    }
    else if (role === 'reporter') {
        document.getElementById('addRecordBtn').classList.remove('hidden');
        document.getElementById('viewDashboardBtn').classList.add('hidden');
        document.getElementById('clearDataBtn').classList.add('hidden');
        document.getElementById('filtersSection').classList.add('hidden');
        document.getElementById('kpiSection').classList.add('hidden');
        document.getElementById('tableSection').classList.add('hidden');
        document.getElementById('reporterOnlyContent').classList.remove('hidden');
        document.getElementById('agencySelection').classList.remove('hidden');
    }

    selectedAgency = null;
    document.getElementById('addRecordBtn').disabled = true;
    document.getElementById('searchCaseBtn').disabled = true;
    document.querySelectorAll('.agency-btn').forEach(btn => btn.classList.remove('selected'));
}

function showLoginScreen() {
    console.log('📱 Showing login screen');
    document.getElementById('loginScreen').classList.remove('hidden');
    document.getElementById('mainDashboard').classList.add('hidden');
}

function showDashboard() {
    console.log('📊 Showing dashboard for user:', currentUser?.name);
    document.getElementById('loginScreen').classList.add('hidden');
    document.getElementById('mainDashboard').classList.remove('hidden');
    
    if (currentUser && (currentUser.role === 'admin' || currentUser.role === 'viewer')) {
        setTimeout(initializeDashboard, 100);
    }
}

function selectAgency(agency) {
    selectedAgency = agency;
    
    document.querySelectorAll('.agency-btn').forEach(btn => {
        btn.classList.remove('selected');
    });
    document.querySelector(`[data-agency="${agency}"]`).classList.add('selected');
    
    document.getElementById('addRecordBtn').disabled = false;
    document.getElementById('searchCaseBtn').disabled = false;
    
    const agencyNames = {
        'NPA': 'National Prosecution Authority',
        'MOH': 'Ministry of Health', 
        'ZP': 'Zambia Police'
    };
    document.getElementById('addRecordBtn').innerHTML = `<span role="img" aria-label="Plus sign">➕</span> Add New Record (${agencyNames[agency]})`;
    document.getElementById('searchCaseBtn').innerHTML = `<span role="img" aria-label="Magnifying glass">🔍</span> Search Case (${agencyNames[agency]})`;
    
    console.log(`📋 Selected agency: ${agency} - ${agencyNames[agency]}`);
}

function convertAgeToYears(age, unit) {
    if (!age || !unit) return null;
    
    const ageNum = parseFloat(age);
    
    if (unit === 'months') {
        return Math.round((ageNum / 12) * 100) / 100;
    } else if (unit === 'years') {
        return ageNum;
    }
    
    return ageNum;
}

function formatAgeDisplay(ageInYears) {
    if (!ageInYears || ageInYears === 0) return 'N/A';
    
    const years = parseFloat(ageInYears);
    
    if (years < 1) {
        const months = Math.round(years * 12);
        return `${months} month${months !== 1 ? 's' : ''}`;
    }
    
    if (years === Math.floor(years)) {
        return `${Math.floor(years)} year${Math.floor(years) !== 1 ? 's' : ''}`;
    }
    
    const wholeYears = Math.floor(years);
    const extraMonths = Math.round((years - wholeYears) * 12);
    
    if (wholeYears === 0) {
        return `${extraMonths} month${extraMonths !== 1 ? 's' : ''}`;
    } else if (extraMonths === 0) {
        return `${wholeYears} year${wholeYears !== 1 ? 's' : ''}`;
    } else {
        return `${wholeYears}y ${extraMonths}m`;
    }
}

function getAgeCategory(ageInYears) {
    if (!ageInYears) return '';
    const years = parseFloat(ageInYears);
    
    if (years < 1) return 'infant';
    if (years < 3) return 'toddler';
    if (years < 13) return 'child';
    return 'teen';
}

async function checkDatabaseConnection() {
    const statusElement = document.getElementById('connectionStatus');
    const statusText = document.getElementById('statusText');
    statusElement.className = 'connection-status status-disconnected';
    statusText.textContent = '❌ Database Offline - Using Local Data';
    isConnectedToDatabase = false;
}

async function loadData() {
    loadFallbackData();
    filteredData = [...allData];
}

function loadFallbackData() {
    const savedData = loadDataFromLocalStorage();
    if (savedData && savedData.length > 0) {
        allData = savedData;
        console.log('💾 Data loaded from localStorage:', allData.length, 'records');
        return;
    }

    const csvData = `cvw code,Record Type,Date Reported,District,CVW Gender,CVW Age,Offender Gender,Offender Age,Crime Type,Disability,Services Rendered,Relationship to CV
NPA-CV1,Victim,1/4/2025,Lusaka,MALE,5,FEMALE,25,ASSAULT ON A CHILD,NON,MEDICAL REPORT,STRANGER
NPA-CV2,Victim,2/2/2025,Lusaka,FEMALE,8,MALE,30,PHYSICAL ABUSE,PHYSICAL,MEDICAL + COUNSELLING,STRANGER
MOH-CV3,Victim,1/27/2025,Solwezi,FEMALE,10,MALE,40,SEXUAL ASSAULT,MENTAL,MEDICAL + COUNSELLING,LANDLORD
ZP-CV4,Victim,3/11/2025,Lusaka,FEMALE,12,MALE,50,RAPE,MENTAL+PHYSICAL,MEDICAL + COUNSELLING,FATHER
NPA-CW5,Witness,2/7/2025,Katete,MALE,15,FEMALE,60,RAPE,NON,COUNSELLING,FRIEND
MOH-CV6,Victim,1/7/2025,Chipata,FEMALE,0.5,FEMALE,20,CHILD NEGLECT,NON,COUNSELLING,FRIEND
ZP-CW7,Witness,2/10/2025,Mansa,MALE,0.75,MALE,30,DEFILEMENT,PHYSICAL,MEDICAL + COUNSELLING,STRANGER`;
const lines = csvData.trim().split('\n');
    const headers = lines[0].split(',');
    const rawData = [];

    for (let i = 1; i < lines.length; i++) {
        const values = lines[i].split(',');
        const row = {};
        headers.forEach((header, index) => {
            row[header] = values[index] || '';
        });
        rawData.push(row);
    }

    allData = rawData.map(row => ({
        ...row,
        'CVW Gender': row['CVW Gender'].replace('FEMAL', 'FEMALE'),
        'Offender Gender': row['Offender Gender'].replace('FEMAL', 'FEMALE'),
        'CVW Age': parseFloat(row['CVW Age']) || 0,
        'Offender Age': parseFloat(row['Offender Age']) || 0,
        'Date Reported': new Date(row['Date Reported'])
    }));

    console.log('📋 Fallback data loaded:', allData.length, 'records');
    saveDataToLocalStorage();
}

function saveDataToLocalStorage() {
    try {
        const dataToSave = allData.map(record => ({
            ...record,
            'Date Reported': record['Date Reported'].toISOString()
        }));
        localStorage.setItem('cvw_dashboard_data', JSON.stringify(dataToSave));
        console.log('💾 Data saved to localStorage:', allData.length, 'records');
    } catch (error) {
        console.error('❌ Error saving to localStorage:', error);
    }
}

function loadDataFromLocalStorage() {
    try {
        const savedData = localStorage.getItem('cvw_dashboard_data');
        if (savedData) {
            const parsedData = JSON.parse(savedData);
            return parsedData.map(record => ({
                ...record,
                'Date Reported': new Date(record['Date Reported'])
            }));
        }
        return null;
    } catch (error) {
        console.error('Error loading from localStorage:', error);
        return null;
    }
}

async function generateCaseId() {
    const recordType = document.getElementById('recordType').value;
    const caseIdInput = document.getElementById('caseId');
    
    if (!recordType || !selectedAgency) {
        caseIdInput.value = '';
        return;
    }
    
    const suffix = recordType === 'Victim' ? 'CV' : 'CW';
    const prefix = `${selectedAgency}-${suffix}`;
    
    const existingIds = allData
        .filter(record => record['cvw code'].startsWith(prefix))
        .map(record => {
            const match = record['cvw code'].match(/(\d+)$/);
            return match ? parseInt(match[1]) : 0;
        });
    
    const nextNumber = existingIds.length > 0 ? Math.max(...existingIds) + 1 : 1;
    caseIdInput.value = `${prefix}${nextNumber}`;
}

function addRecordLocally(recordData) {
    console.log('📱 Adding record locally:', recordData);
    
    const newRecord = {
        'cvw code': recordData.caseId,
        'Record Type': recordData.recordType,
        'Date Reported': new Date(recordData.dateReported),
        'District': recordData.district,
        'CVW Gender': recordData.cvwGender,
        'CVW Age': parseFloat(recordData.cvwAge) || 0,
        'Offender Gender': recordData.offenderGender || '',
        'Offender Age': parseInt(recordData.offenderAge) || 0,
        'Crime Type': recordData.crimeType,
        'Disability': recordData.disability || 'NON',
        'Services Rendered': recordData.servicesRendered || '',
        'Relationship to CV': recordData.relationshipToCv || ''
    };
    
    allData.push(newRecord);
    filteredData = [...allData];
    
    saveDataToLocalStorage();
    
    if (currentUser && (currentUser.role === 'admin' || currentUser.role === 'viewer')) {
        updateFilters();
        updateDashboard();
    }
    
    console.log('💾 Record saved locally. Total records:', allData.length);
}

function updateFilters() {
    const districts = [...new Set(allData.map(d => d.District))].sort();
    const districtSelect = document.getElementById('districtFilter');
    const currentValue = districtSelect.value;
    
    districtSelect.innerHTML = '<option value="">All Districts</option>';
    districts.forEach(district => {
        const option = document.createElement('option');
        option.value = district;
        option.textContent = district;
        districtSelect.appendChild(option);
    });
    districtSelect.value = currentValue;

    const crimeTypes = [...new Set(allData.map(d => d['Crime Type']))].sort();
    const crimeSelect = document.getElementById('crimeTypeFilter');
    const currentCrimeValue = crimeSelect.value;
    
    crimeSelect.innerHTML = '<option value="">All Crime Types</option>';
    crimeTypes.forEach(crime => {
        const option = document.createElement('option');
        option.value = crime;
        option.textContent = crime;
        crimeSelect.appendChild(option);
    });
    crimeSelect.value = currentCrimeValue;

    const services = [...new Set(allData.map(d => d['Services Rendered']).filter(s => s))].sort();
    const servicesSelect = document.getElementById('servicesFilter');
    const currentServicesValue = servicesSelect.value;
    
    servicesSelect.innerHTML = '<option value="">All Services</option>';
    services.forEach(service => {
        const option = document.createElement('option');
        option.value = service;
        option.textContent = service;
        servicesSelect.appendChild(option);
    });
    servicesSelect.value = currentServicesValue;
}

function setupFilters() {
    updateFilters();

    document.getElementById('districtFilter').addEventListener('change', applyFilters);
    document.getElementById('recordTypeFilter').addEventListener('change', applyFilters);
    document.getElementById('crimeTypeFilter').addEventListener('change', applyFilters);
    document.getElementById('genderFilter').addEventListener('change', applyFilters);
    document.getElementById('servicesFilter').addEventListener('change', applyFilters);
    document.getElementById('dateFromFilter').addEventListener('change', applyFilters);
    document.getElementById('dateToFilter').addEventListener('change', applyFilters);
}

function applyFilters() {
    const districtFilter = document.getElementById('districtFilter').value;
    const recordTypeFilter = document.getElementById('recordTypeFilter').value;
    const crimeTypeFilter = document.getElementById('crimeTypeFilter').value;
    const genderFilter = document.getElementById('genderFilter').value;
    const servicesFilter = document.getElementById('servicesFilter').value;
    const dateFromFilter = document.getElementById('dateFromFilter').value;
    const dateToFilter = document.getElementById('dateToFilter').value;

    filteredData = allData.filter(row => {
        const dateMatch = (!dateFromFilter || row['Date Reported'] >= new Date(dateFromFilter)) &&
                         (!dateToFilter || row['Date Reported'] <= new Date(dateToFilter));
        
        return (!districtFilter || row.District === districtFilter) &&
               (!recordTypeFilter || row['Record Type'] === recordTypeFilter) &&
               (!crimeTypeFilter || row['Crime Type'] === crimeTypeFilter) &&
               (!genderFilter || row['CVW Gender'] === genderFilter) &&
               (!servicesFilter || row['Services Rendered'] === servicesFilter) &&
               dateMatch;
    });

    updateDashboard();
}

function resetFilters() {
    document.getElementById('districtFilter').value = '';
    document.getElementById('recordTypeFilter').value = '';
    document.getElementById('crimeTypeFilter').value = '';
    document.getElementById('genderFilter').value = '';
    document.getElementById('servicesFilter').value = '';
    document.getElementById('dateFromFilter').value = '';
    document.getElementById('dateToFilter').value = '';
    filteredData = [...allData];
    updateDashboard();
}

function updateDashboard() {
    updateKPIs();
    updateTable();
}

function updateKPIs() {
    const totalCases = filteredData.length;
    const victimCases = filteredData.filter(d => d['Record Type'] === 'Victim').length;
    const witnessCases = filteredData.filter(d => d['Record Type'] === 'Witness').length;
    const avgAge = filteredData.filter(d => d['CVW Age'] > 0).reduce((sum, d) => sum + d['CVW Age'], 0) / filteredData.filter(d => d['CVW Age'] > 0).length || 0;

    const totalElement = document.getElementById('totalCases');
    const victimElement = document.getElementById('victimCases');
    const witnessElement = document.getElementById('witnessCases');
    const avgAgeElement = document.getElementById('avgAge');

    if (totalElement) totalElement.textContent = totalCases;
    if (victimElement) victimElement.textContent = victimCases;
    if (witnessElement) witnessElement.textContent = witnessCases;
    if (avgAgeElement) avgAgeElement.textContent = formatAgeDisplay(avgAge);
}

function updateTable() {
    const tbody = document.getElementById('caseTableBody');
    if (!tbody) return;
    
    tbody.innerHTML = '';

    const displayData = filteredData.slice(0, 50);

    displayData.forEach(row => {
        const ageDisplay = formatAgeDisplay(row['CVW Age']);
        const ageCategory = getAgeCategory(row['CVW Age']);
        
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>${row['cvw code']}</td>
            <td><span class="status-badge ${row['Record Type'].toLowerCase()}-badge">${row['Record Type']}</span></td>
            <td>${row['Date Reported'].toLocaleDateString()}</td>
            <td>${row['District']}</td>
            <td>${row['CVW Gender']}</td>
            <td><span class="age-display ${ageCategory}">${ageDisplay}</span></td>
            <td>${row['Crime Type']}</td>
            <td>${row['Disability']}</td>
            <td>${row['Services Rendered']}</td>
            <td>${row['Relationship to CV']}</td>
        `;
        tbody.appendChild(tr);
    });

    if (filteredData.length > 50) {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td colspan="10" style="text-align: center; font-style: italic; color: #666;">Showing first 50 of ${filteredData.length} records</td>`;
        tbody.appendChild(tr);
    }

    if (filteredData.length === 0) {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td colspan="10" style="text-align: center; color: #666;">No records found</td>`;
        tbody.appendChild(tr);
    }
}

function openAddRecordModal() {
    if (!hasPermission('add')) {
        alert('❌ You do not have permission to add records.');
        return;
    }
    
    if (!selectedAgency) {
        alert('⚠️ Please select a reporting agency first.');
        return;
    }
    
    document.getElementById('addRecordModal').style.display = 'block';
    document.getElementById('dateReported').value = new Date().toISOString().split('T')[0];
    document.getElementById('caseId').value = '';
    
    const agencyNames = {
        'NPA': 'National Prosecution Authority',
        'MOH': 'Ministry of Health', 
        'ZP': 'Zambia Police'
    };
    document.querySelector('#addRecordModal .modal-title').innerHTML = `➕ Add New Case Record - ${agencyNames[selectedAgency]}`;
}

function closeAddRecordModal() {
    document.getElementById('addRecordModal').style.display = 'none';
    document.getElementById('addRecordForm').reset();
    hideMessages();
    
    const ageInput = document.getElementById('cvwAge');
    if (ageInput) {
        ageInput.style.borderColor = '#dee2e6';
        ageInput.style.backgroundColor = 'white';
    }
    updateRelationshipLabel();
}

function updateRelationshipLabel() {
    const recordType = document.getElementById('recordType').value;
    const relationshipLabel = document.getElementById('relationshipLabel');
    
    if (recordType === 'Victim') {
        relationshipLabel.textContent = 'Relationship to Victim';
    } else if (recordType === 'Witness') {
        relationshipLabel.textContent = 'Relationship to Witness';
    } else {
        relationshipLabel.textContent = 'Relationship to Child';
    }
}

function setupAgeInputHandlers() {
    const ageInput = document.getElementById('cvwAge');
    const ageUnit = document.getElementById('ageUnit');
    
    if (ageInput && ageUnit) {
        ageUnit.addEventListener('change', function() {
            const unit = this.value;
            
            if (unit === 'months') {
                ageInput.max = '60';
                ageInput.placeholder = 'Enter months (0-60)';
                ageInput.style.borderColor = '#dc2626';
                ageInput.style.backgroundColor = '#fef2f2';
            } else if (unit === 'years') {
                ageInput.max = '18';
                ageInput.placeholder = 'Enter years (0-18)';
                ageInput.style.borderColor = '#dee2e6';
                ageInput.style.backgroundColor = 'white';
            } else {
                ageInput.max = '120';
                ageInput.placeholder = 'Enter age';
                ageInput.style.borderColor = '#dee2e6';
                ageInput.style.backgroundColor = 'white';
            }
            
            ageInput.value = '';
        });

        ageInput.addEventListener('input', function() {
            const unit = ageUnit.value;
            const value = parseFloat(this.value);
            
            if (unit === 'months' && value > 60) {
                this.setCustomValidity('Maximum 60 months (5 years). Use "Years" for older children.');
            } else if (unit === 'years' && value > 18) {
                this.setCustomValidity('Maximum 18 years for CVW cases.');
            } else if (value < 0) {
                this.setCustomValidity('Age cannot be negative.');
            } else {
                this.setCustomValidity('');
            }
        });
    }
}

function showDashboardView() {
    const kpiSection = document.getElementById('kpiSection');
    if (kpiSection) {
        kpiSection.scrollIntoView({ behavior: 'smooth' });
    }
}

function showSuccessMessage(message) {
    const successMsg = document.getElementById('successMessage');
    if (successMsg) {
        successMsg.textContent = message;
        successMsg.style.display = 'block';
        setTimeout(() => {
            successMsg.style.display = 'none';
        }, 3000);
    }
}

function showErrorMessage(message) {
    const errorMsg = document.getElementById('errorMessage');
    if (errorMsg) {
        errorMsg.textContent = message;
        errorMsg.style.display = 'block';
        setTimeout(() => {
            errorMsg.style.display = 'none';
        }, 5000);
    }
}

function hideMessages() {
    const successMsg = document.getElementById('successMessage');
    const errorMsg = document.getElementById('errorMessage');
    if (successMsg) successMsg.style.display = 'none';
    if (errorMsg) errorMsg.style.display = 'none';
}

function clearAllData() {
    if (!hasPermission('admin')) {
        alert('❌ You do not have permission to clear data.');
        return;
    }
    
    if (confirm('⚠️ Are you sure you want to clear ALL data? This cannot be undone!')) {
        localStorage.removeItem('cvw_dashboard_data');
        allData = [];
        filteredData = [];
        updateDashboard();
        alert('✅ All data cleared successfully!');
        
        loadFallbackData();
        filteredData = [...allData];
        updateFilters();
        updateDashboard();
    }
}

function openSearchCaseModal() {
    if (!selectedAgency) {
        alert('⚠️ Please select a reporting agency first.');
        return;
    }
    
    document.getElementById('searchCaseModal').style.display = 'block';
    document.getElementById('searchCaseId').value = '';
    document.getElementById('caseDetailsSection').classList.add('hidden');
    document.getElementById('serviceDate').value = new Date().toISOString().split('T')[0];
    
    const agencyNames = {
        'NPA': 'National Prosecution Authority',
        'MOH': 'Ministry of Health', 
        'ZP': 'Zambia Police'
    };
    document.getElementById('currentAgencyBadge').textContent = `${selectedAgency} - ${agencyNames[selectedAgency]}`;
    
    hideSearchMessages();
}

function closeSearchCaseModal() {
    document.getElementById('searchCaseModal').style.display = 'none';
    document.getElementById('caseDetailsSection').classList.add('hidden');
    hideSearchMessages();
}

function searchCase() {
    const caseId = document.getElementById('searchCaseId').value.trim().toUpperCase();
    
    if (!caseId) {
        showSearchErrorMessage('Please enter a Case ID');
        return;
    }
    
    const foundCase = allData.find(record => record['cvw code'].toUpperCase() === caseId);
    
    if (foundCase) {
        displayCaseDetails(foundCase);
        showSearchSuccessMessage(`Case ${caseId} found! You can now add services provided by your agency.`);
    } else {
        document.getElementById('caseDetailsSection').classList.add('hidden');
        showSearchErrorMessage(`Case ${caseId} not found in the system. Please verify the Case ID format (e.g., NPA-CV1, MOH-CW5, ZP-CV12).`);
    }
}

function displayCaseDetails(caseData) {
    const reportingAgency = caseData['cvw code'].split('-')[0];
    const agencyNames = {
        'NPA': 'National Prosecution Authority',
        'MOH': 'Ministry of Health', 
        'ZP': 'Zambia Police'
    };
    
    document.getElementById('foundCaseId').value = caseData['cvw code'];
    document.getElementById('foundReportingAgency').value = `${reportingAgency} - ${agencyNames[reportingAgency] || 'Unknown Agency'}`;
    document.getElementById('foundRecordType').value = caseData['Record Type'];
    document.getElementById('foundDateReported').value = caseData['Date Reported'].toLocaleDateString();
    document.getElementById('foundDistrict').value = caseData['District'];
    document.getElementById('foundCvwGender').value = caseData['CVW Gender'];
    document.getElementById('foundCvwAge').value = formatAgeDisplay(caseData['CVW Age']);
    document.getElementById('foundCrimeType').value = caseData['Crime Type'];
    document.getElementById('foundDisability').value = caseData['Disability'] || 'NON';
    
    const currentServices = caseData['Services Rendered'] || 'No services recorded yet';
    document.getElementById('foundServicesRendered').value = currentServices;
    
    document.getElementById('additionalService').value = '';
    document.getElementById('serviceNotes').value = '';
    
    document.getElementById('caseDetailsSection').classList.remove('hidden');
    document.getElementById('caseDetailsSection').scrollIntoView({ behavior: 'smooth', block: 'start' });
}

function addServiceToCase() {
    const caseId = document.getElementById('foundCaseId').value;
    const additionalService = document.getElementById('additionalService').value;
    const serviceDate = document.getElementById('serviceDate').value;
    const serviceNotes = document.getElementById('serviceNotes').value.trim();
    
    if (!additionalService) {
        showSearchErrorMessage('Please select a service that your agency provided');
        return;
    }
    
    if (!serviceDate) {
        showSearchErrorMessage('Please enter the date when the service was provided');
        return;
    }
    
    const today = new Date().toISOString().split('T')[0];
    if (serviceDate > today) {
        showSearchErrorMessage('Service date cannot be in the future');
        return;
    }

    const caseIndex = allData.findIndex(record => record['cvw code'] === caseId);
    
    if (caseIndex !== -1) {
        const currentServices = allData[caseIndex]['Services Rendered'] || '';
        const agencyPrefix = selectedAgency;
        
        let newServiceEntry = `${additionalService} (${agencyPrefix} - ${new Date(serviceDate).toLocaleDateString()})`;
<artifacts>
<invoke name="artifacts">
<parameter name="command">update</parameter>
<parameter name="id">cvw_fully_fixed_complete</parameter>
<parameter name="old_str">            let newServiceEntry = `${additionalService} (${agencyPrefix} - ${new Date(serviceDate).toLocaleDateString()})`;
<artifacts>
<invoke name="artifacts">
<parameter name="command">update</parameter>
<parameter name="id">cvw_fully_fixed_complete</parameter>
<parameter name="old_str">            let newServiceEntry = `${additionalService} (${agencyPrefix} - ${new Date(serviceDate).toLocaleDateString()})`;</parameter>
<parameter name="new_str">            let newServiceEntry = `${additionalService} (${agencyPrefix} - ${new Date(serviceDate).toLocaleDateString()})`;
            if (serviceNotes) {
                newServiceEntry += ` [${serviceNotes}]`;
            }
let updatedServices;
        if (currentServices && currentServices !== 'No services recorded yet' && currentServices !== 'No services recorded') {
            updatedServices = `${currentServices} + ${newServiceEntry}`;
        } else {
            updatedServices = newServiceEntry;
        }

        allData[caseIndex]['Services Rendered'] = updatedServices;
        document.getElementById('foundServicesRendered').value = updatedServices;
        
        saveDataToLocalStorage();
        
        if (currentUser && (currentUser.role === 'admin' || currentUser.role === 'viewer')) {
            updateFilters();
            updateDashboard();
        }
        
        const agencyNames = {
            'NPA': 'National Prosecution Authority',
            'MOH': 'Ministry of Health', 
            'ZP': 'Zambia Police'
        };
        
        showSearchSuccessMessage(`✅ Service "${additionalService}" successfully added to case ${caseId} by ${agencyNames[selectedAgency]} (${selectedAgency})`);
        
        document.getElementById('additionalService').value = '';
        document.getElementById('serviceNotes').value = '';
        
        console.log('✅ Inter-agency service collaboration recorded successfully');
    } else {
        showSearchErrorMessage('Error: Case not found in database. Please try searching again.');
    }
}

function showSearchSuccessMessage(message) {
    const successMsg = document.getElementById('searchSuccessMessage');
    successMsg.textContent = message;
    successMsg.style.display = 'block';
    document.getElementById('searchErrorMessage').style.display = 'none';
    setTimeout(() => {
        successMsg.style.display = 'none';
    }, 6000);
}

function showSearchErrorMessage(message) {
    const errorMsg = document.getElementById('searchErrorMessage');
    errorMsg.textContent = message;
    errorMsg.style.display = 'block';
    document.getElementById('searchSuccessMessage').style.display = 'none';
    setTimeout(() => {
        errorMsg.style.display = 'none';
    }, 6000);
}

function hideSearchMessages() {
    document.getElementById('searchSuccessMessage').style.display = 'none';
    document.getElementById('searchErrorMessage').style.display = 'none';
}

async function initializeDashboard() {
    try {
        console.log('🚀 Initializing CVW Dashboard...');
        await checkDatabaseConnection();
        await loadData();
        setupFilters();
        updateDashboard();
        console.log('✅ Dashboard initialized successfully');
    } catch (error) {
        console.error('❌ Error initializing dashboard:', error);
    }
}

document.addEventListener('DOMContentLoaded', function() {
    console.log('🚀 CVW Dashboard loaded, setting up...');
    
    if (!checkSession()) {
        showLoginScreen();
    }

    const loginForm = document.getElementById('loginForm');
    if (loginForm) {
        console.log('✅ Login form found, attaching event listener');
        loginForm.addEventListener('submit', function(e) {
            e.preventDefault();
            console.log('📝 Login form submitted');
            
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value.trim();
            
            console.log('🔐 Login attempt:', username, password ? '[PASSWORD PROVIDED]' : '[NO PASSWORD]');
            
            if (!username || !password) {
                console.log('❌ Missing credentials');
                document.getElementById('loginError').style.display = 'block';
                document.getElementById('loginError').textContent = '❌ Please enter both username and password';
                return;
            }
            
            console.log('🔄 Calling login function...');
            if (login(username, password)) {
                console.log('✅ Login successful');
                document.getElementById('loginError').style.display = 'none';
            } else {
                console.log('❌ Login failed');
                document.getElementById('loginError').style.display = 'block';
                document.getElementById('loginError').textContent = '❌ Invalid username or password';
            }
        });
    } else {
        console.error('❌ Login form not found!');
    }

    setupAgeInputHandlers();
    
    const addRecordForm = document.getElementById('addRecordForm');
    if (addRecordForm) {
        addRecordForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            if (!hasPermission('add')) {
                showErrorMessage('❌ You do not have permission to add records.');
                return;
            }
            
            const submitBtn = e.target.querySelector('.submit-btn');
            const originalText = submitBtn.innerHTML;
            submitBtn.disabled = true;
            submitBtn.innerHTML = '⏳ Saving...';
            
            try {
                const recordData = {
                    caseId: document.getElementById('caseId').value,
                    recordType: document.getElementById('recordType').value,
                    dateReported: document.getElementById('dateReported').value,
                    district: document.getElementById('district').value,
                    cvwGender: document.getElementById('cvwGender').value,
                    disability: document.getElementById('disability').value,
                    cvwAge: document.getElementById('cvwAge').value,
                    ageUnit: document.getElementById('ageUnit').value,
                    servicesRendered: document.getElementById('servicesRendered').value,
                    offenderGender: document.getElementById('offenderGender').value,
                    crimeType: document.getElementById('crimeType').value,
                    offenderAge: document.getElementById('offenderAge').value,
                    relationshipToCv: document.getElementById('relationshipToCv').value
                };
                
                const requiredFields = ['recordType', 'dateReported', 'district', 'cvwGender', 'crimeType', 'cvwAge', 'ageUnit'];
                const missingFields = requiredFields.filter(field => !recordData[field] || recordData[field].trim() === '');
                
                if (missingFields.length > 0) {
                    showErrorMessage('Please fill in all required fields: ' + missingFields.join(', '));
                    return;
                }
                
                if (!selectedAgency) {
                    showErrorMessage('⚠️ Please select a reporting agency first.');
                    return;
                }
                
                const ageInYears = convertAgeToYears(recordData.cvwAge, recordData.ageUnit);
                recordData.cvwAge = ageInYears;
                
                if (!recordData.caseId) {
                    await generateCaseId();
                    recordData.caseId = document.getElementById('caseId').value;
                }
                
                addRecordLocally(recordData);
                
                if (currentUser.role === 'admin' || currentUser.role === 'viewer') {
                    updateFilters();
                    applyFilters();
                }
                
                const ageDisplay = formatAgeDisplay(ageInYears);
                showSuccessMessage(`✅ Record added successfully! Case ID: ${recordData.caseId} (Age: ${ageDisplay})`);
                
                setTimeout(() => {
                    closeAddRecordModal();
                }, 2000);
                
            } catch (error) {
                console.error('❌ Form submission error:', error);
                showErrorMessage(`❌ Error adding record: ${error.message}`);
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;
            }
        });
    }
});

window.onclick = function(event) {
    const addModal = document.getElementById('addRecordModal');
    const searchModal = document.getElementById('searchCaseModal');
    
    if (event.target == addModal) {
        closeAddRecordModal();
    }
    if (event.target == searchModal) {
        closeSearchCaseModal();
    }
};
</script>
</body>
</html></parameter>
</invoke>
</artifacts>

