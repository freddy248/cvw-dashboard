<artifacts>
<invoke name="artifacts">
<parameter name="command">update</parameter>
<parameter name="id">cvw_dashboard_with_auth</parameter>
<parameter name="old_str">            <!-- Action Buttons (Role-based visibility) -->
            <div class="action-buttons" id="actionButtons">
                <button class="action-btn add-record-btn" id="addRecordBtn" onclick="openAddRecordModal()">
                    ‚ûï Add New Record
                </button>
                <button class="action-btn view-dashboard-btn" id="viewDashboardBtn" onclick="showDashboardView()">
                    üìà View Dashboard
                </button>
                <button class="action-btn" id="clearDataBtn" style="background: linear-gradient(135deg, #ff6b6b, #ee5a52);" onclick="clearAllData()" title="Clear all locally saved data">
                    üóëÔ∏è Clear Data
                </button>
            </div></parameter>
<parameter name="new_str">            <!-- Reporting Agency Selection (For Admin and Reporter) -->
            <div id="agencySelection" class="filters-section hidden" style="margin-bottom: 20px;">
                <h3 style="text-align: center; color: #2c3e50; margin-bottom: 20px;">üèõÔ∏è Select Reporting Agency</h3>
                <div style="display: flex; justify-content: center; gap: 15px; flex-wrap: wrap;">
                    <button class="agency-btn" data-agency="NPA" onclick="selectAgency('NPA')">
                        <div class="agency-icon">‚öñÔ∏è</div>
                        <div class="agency-name">National Prosecution Authority</div>
                        <div class="agency-code">NPA</div>
                    </button>
                    <button class="agency-btn" data-agency="MOH" onclick="selectAgency('MOH')">
                        <div class="agency-icon">üè•</div>
                        <div class="agency-name">Ministry of Health</div>
                        <div class="agency-code">MOH</div>
                    </button>
                    <button class="agency-btn" data-agency="ZP" onclick="selectAgency('ZP')">
                        <div class="agency-icon">üëÆ</div>
                        <div class="agency-name">Zambia Police</div>
                        <div class="agency-code">ZP</div>
                    </button>
                </div>
            </div>
<!-- Action Buttons (Role-based visibility) -->
        <div class="action-buttons" id="actionButtons">
            <button class="action-btn add-record-btn" id="addRecordBtn" onclick="openAddRecordModal()" disabled>
                ‚ûï Add New Record
            </button>
            <button class="action-btn view-dashboard-btn" id="viewDashboardBtn" onclick="showDashboardView()">
                üìà View Dashboard
            </button>
            <button class="action-btn" id="clearDataBtn" style="background: linear-gradient(135deg, #ff6b6b, #ee5a52);" onclick="clearAllData()" title="Clear all locally saved data">
                üóëÔ∏è Clear Data
            </button>
        </div></parameter>
</invoke>
</artifacts>
<artifacts>
<invoke name="artifacts">
<parameter name="command">update</parameter>
<parameter name="id">cvw_dashboard_with_auth</parameter>
<parameter name="old_str">        let allData = [];
        let filteredData = [];
        let charts = {};
        let isConnectedToDatabase = false;
        let currentUser = null;</parameter>
<parameter name="new_str">        let allData = [];
        let filteredData = [];
        let charts = {};
        let isConnectedToDatabase = false;
        let currentUser = null;
        let selectedAgency = null;</parameter>
</invoke>
</artifacts>
<artifacts>
<invoke name="artifacts">
<parameter name="command">update</parameter>
<parameter name="id">cvw_dashboard_with_auth</parameter>
<parameter name="old_str">            // Role-based visibility
            const role = currentUser.role;
// Admin: Full access
        if (role === 'admin') {
            document.getElementById('addRecordBtn').classList.remove('hidden');
            document.getElementById('viewDashboardBtn').classList.remove('hidden');
            document.getElementById('clearDataBtn').classList.remove('hidden');
            document.getElementById('filtersSection').classList.remove('hidden');
            document.getElementById('kpiSection').classList.remove('hidden');
            document.getElementById('chartsSection').classList.remove('hidden');
            document.getElementById('tableSection').classList.remove('hidden');
            document.getElementById('reporterOnlyContent').classList.add('hidden');
        }
        // Viewer: Read-only access
        else if (role === 'viewer') {
            document.getElementById('addRecordBtn').classList.add('hidden');
            document.getElementById('viewDashboardBtn').classList.remove('hidden');
            document.getElementById('clearDataBtn').classList.add('hidden');
            document.getElementById('filtersSection').classList.remove('hidden');
            document.getElementById('kpiSection').classList.remove('hidden');
            document.getElementById('chartsSection').classList.remove('hidden');
            document.getElementById('tableSection').classList.remove('hidden');
            document.getElementById('reporterOnlyContent').classList.add('hidden');
        }
        // Reporter: Add records only
        else if (role === 'reporter') {
            document.getElementById('addRecordBtn').classList.remove('hidden');
            document.getElementById('viewDashboardBtn').classList.add('hidden');
            document.getElementById('clearDataBtn').classList.add('hidden');
            document.getElementById('filtersSection').classList.add('hidden');
            document.getElementById('kpiSection').classList.add('hidden');
            document.getElementById('chartsSection').classList.add('hidden');
            document.getElementById('tableSection').classList.add('hidden');
            document.getElementById('reporterOnlyContent').classList.remove('hidden');
        }</parameter>
<parameter name="new_str">            // Role-based visibility
const role = currentUser.role;
// Admin: Full access
        if (role === 'admin') {
            document.getElementById('addRecordBtn').classList.remove('hidden');
            document.getElementById('viewDashboardBtn').classList.remove('hidden');
            document.getElementById('clearDataBtn').classList.remove('hidden');
            document.getElementById('filtersSection').classList.remove('hidden');
            document.getElementById('kpiSection').classList.remove('hidden');
            document.getElementById('chartsSection').classList.remove('hidden');
            document.getElementById('tableSection').classList.remove('hidden');
            document.getElementById('reporterOnlyContent').classList.add('hidden');
            document.getElementById('agencySelection').classList.remove('hidden');
        }
        // Viewer: Read-only access
        else if (role === 'viewer') {
            document.getElementById('addRecordBtn').classList.add('hidden');
            document.getElementById('viewDashboardBtn').classList.remove('hidden');
            document.getElementById('clearDataBtn').classList.add('hidden');
            document.getElementById('filtersSection').classList.remove('hidden');
            document.getElementById('kpiSection').classList.remove('hidden');
            document.getElementById('chartsSection').classList.remove('hidden');
            document.getElementById('tableSection').classList.remove('hidden');
            document.getElementById('reporterOnlyContent').classList.add('hidden');
            document.getElementById('agencySelection').classList.add('hidden');
        }
        // Reporter: Add records only
        else if (role === 'reporter') {
            document.getElementById('addRecordBtn').classList.remove('hidden');
            document.getElementById('viewDashboardBtn').classList.add('hidden');
            document.getElementById('clearDataBtn').classList.add('hidden');
            document.getElementById('filtersSection').classList.add('hidden');
            document.getElementById('kpiSection').classList.add('hidden');
            document.getElementById('chartsSection').classList.add('hidden');
            document.getElementById('tableSection').classList.add('hidden');
            document.getElementById('reporterOnlyContent').classList.remove('hidden');
            document.getElementById('agencySelection').classList.remove('hidden');
        }

        // Reset agency selection and button state
        selectedAgency = null;
        document.getElementById('addRecordBtn').disabled = true;
        document.querySelectorAll('.agency-btn').forEach(btn => btn.classList.remove('selected'));</parameter>
</invoke>
</artifacts>
<artifacts>
<invoke name="artifacts">
<parameter name="command">update</parameter>
<parameter name="id">cvw_dashboard_with_auth</parameter>
<parameter name="old_str">        function generateLocalCaseId(recordType) {
            const prefix = recordType === 'Victim' ? 'NPA-CV' : 'ZP-CW';
            const existingIds = allData
                .filter(record => record['cvw code'].startsWith(prefix))
                .map(record => {
                    const match = record['cvw code'].match(/(\d+)$/);
                    return match ? parseInt(match[1]) : 0;
                });
const nextNumber = existingIds.length > 0 ? Math.max(...existingIds) + 1 : 1;
        document.getElementById('caseId').value = `${prefix}${nextNumber}`;
    }</parameter>
</invoke>
</artifacts>
<artifacts>
<invoke name="artifacts">
<parameter name="command">update</parameter>
<parameter name="id">cvw_dashboard_with_auth</parameter>
<parameter name="old_str">        // Modal functions
        function openAddRecordModal() {
            // Check permissions
            if (!hasPermission('add')) {
                alert('‚ùå You do not have permission to add records.');
                return;
            }
document.getElementById('addRecordModal').style.display = 'block';
        document.getElementById('dateReported').value = new Date().toISOString().split('T')[0];
        document.getElementById('caseId').value = '';
    }</parameter>
<parameter name="new_str">        // Agency selection function
function selectAgency(agency) {
selectedAgency = agency;
// Update button states
        document.querySelectorAll('.agency-btn').forEach(btn => {
            btn.classList.remove('selected');
        });
        document.querySelector(`[data-agency="${agency}"]`).classList.add('selected');
        
        // Enable add record button
        document.getElementById('addRecordBtn').disabled = false;
        
        // Update button text to show selected agency
        const agencyNames = {
            'NPA': 'National Prosecution Authority',
            'MOH': 'Ministry of Health', 
            'ZP': 'Zambia Police'
        };
        document.getElementById('addRecordBtn').innerHTML = `‚ûï Add New Record (${agencyNames[agency]})`;
        
        console.log(`üìã Selected agency: ${agency} - ${agencyNames[agency]}`);
    }

    // Modal functions
    function openAddRecordModal() {
        // Check permissions
        if (!hasPermission('add')) {
            alert('‚ùå You do not have permission to add records.');
            return;
        }
        
        // Check if agency is selected
        if (!selectedAgency) {
            alert('‚ö†Ô∏è Please select a reporting agency first.');
            return;
        }
        
        document.getElementById('addRecordModal').style.display = 'block';
        document.getElementById('dateReported').value = new Date().toISOString().split('T')[0];
        document.getElementById('caseId').value = '';
        
        // Update modal title to show selected agency
        const agencyNames = {
            'NPA': 'National Prosecution Authority',
            'MOH': 'Ministry of Health', 
            'ZP': 'Zambia Police'
        };
        document.querySelector('.modal-title').innerHTML = `‚ûï Add New Case Record - ${agencyNames[selectedAgency]}`;
    }</parameter>
</invoke>
</artifacts>
<artifacts>
<invoke name="artifacts">
<parameter name="command">update</parameter>
<parameter name="id">cvw_dashboard_with_auth</parameter>
<parameter name="old_str">            <!-- Reporter-only Content -->
            <div id="reporterOnlyContent" class="hidden">
                <div class="access-denied">
                    <h2>üìù Reporter Dashboard</h2>
                    <p>Welcome! You have access to add new case records.</p>
                    <p>Click "Add New Record" above to report a new case.</p>
                </div>
            </div></parameter>
<parameter name="new_str">            <!-- Reporter-only Content -->
            <div id="reporterOnlyContent" class="hidden">
                <div class="access-denied">
                    <h2>üìù Reporter Dashboard</h2>
                    <p>Welcome! You have access to add new case records.</p>
                    <p><strong>Step 1:</strong> Select your reporting agency above</p>
                    <p><strong>Step 2:</strong> Click "Add New Record" to report a new case</p>
                    <br>
                    <div style="background: #e3f2fd; padding: 15px; border-radius: 8px; border-left: 4px solid #2196f3;">
                        <strong>Case ID Prefixes:</strong><br>
                        ‚Ä¢ <strong>NPA-CV/CW:</strong> National Prosecution Authority<br>
                        ‚Ä¢ <strong>MOH-CV/CW:</strong> Ministry of Health<br>
                        ‚Ä¢ <strong>ZP-CV/CW:</strong> Zambia Police
                    </div>
                </div>
            </div></parameter>
</invoke>
</artifacts>
<artifacts>
<invoke name="artifacts">
<parameter name="command">update</parameter>
<parameter name="id">cvw_dashboard_with_auth</parameter>
<parameter name="old_str">                    <div class="form-group">
                        <label for="caseId">Case ID</label>
                        <input type="text" id="caseId" name="caseId" placeholder="Auto-generated if empty" readonly>
                        <small style="color: #666; margin-top: 5px;">Will be auto-generated based on record type</small>
                    </div></parameter>
<parameter name="new_str">                    <div class="form-group">
                        <label for="caseId">Case ID</label>
                        <input type="text" id="caseId" name="caseId" placeholder="Auto-generated based on agency and record type" readonly>
                        <small style="color: #666; margin-top: 5px;">Format: [AGENCY]-[CV/CW][NUMBER] (e.g., NPA-CV1, MOH-CW5, ZP-CV12)</small>
                    </div></parameter>
</invoke>
</artifacts>
<artifacts>
<invoke name="artifacts">
<parameter name="command">update</parameter>
<parameter name="id">cvw_dashboard_with_auth</parameter>
<parameter name="old_str">                            .age-input-container select {
                                flex: none;
                                width: 100%;
                            }
.user-info-bar {
                            flex-direction: column;
                            gap: 10px;
                            text-align: center;
                        }
                    }</parameter>
<parameter name="new_str">                            .age-input-container select {
flex: none;
width: 100%;
}
.user-info-bar {
                            flex-direction: column;
                            gap: 10px;
                            text-align: center;
                        }

                        #agencySelection {
                            margin-bottom: 10px;
                        }

                        #agencySelection > div {
                            flex-direction: column;
                            gap: 10px;
                        }

                        .agency-btn {
                            min-width: auto;
                            width: 100%;
                        }
                    }</parameter>
</invoke>
</artifacts>
