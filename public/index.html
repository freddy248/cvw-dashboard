<artifacts>
<invoke name="artifacts">
<parameter name="command">update</parameter>
<parameter name="id">cvw_dashboard_complete_final</parameter>
<parameter name="old_str">    // Login form handler
    document.addEventListener('DOMContentLoaded', function() {
        // Check for existing session
        if (!checkSession()) {
            showLoginScreen();
        }
// Login form submission
    document.getElementById('loginForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const username = document.getElementById('username').value;
        const password = document.getElementById('password').value;
        
        if (login(username, password)) {
            document.getElementById('loginError').style.display = 'none';
        } else {
            document.getElementById('loginError').style.display = 'block';
        }
    });

    // Setup age input handlers
    setupAgeInputHandlers();
    
    // Form submission for adding records
    document.getElementById('addRecordForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        // Check permissions
        if (!hasPermission('add')) {
            showErrorMessage('‚ùå You do not have permission to add records.');
            return;
        }
        
        const formData = new FormData(e.target);
        const recordData = {};
        
        // Collect form data
        for (let [key, value] of formData.entries()) {
            recordData[key] = value;
        }
        
        // Validate required fields
        const requiredFields = ['recordType', 'dateReported', 'district', 'cvwGender', 'crimeType', 'cvwAge', 'ageUnit'];
        const missingFields = requiredFields.filter(field => !recordData[field]);
        
        if (missingFields.length > 0) {
            showErrorMessage('Please fill in all required fields: ' + missingFields.join(', '));
            return;
        }
        
        // Convert age to years for database storage
        const originalAge = recordData.cvwAge;
        const originalUnit = recordData.ageUnit;
        const ageInYears = convertAgeToYears(originalAge, originalUnit);
        
        recordData.cvwAge = ageInYears;
        
        // Auto-generate case ID if needed
        if (!recordData.caseId) {
            await generateCaseId();
            recordData.caseId = document.getElementById('caseId').value;
        }
        
        try {
            const result = await addRecord(recordData);
            
            // Update filters and dashboard for admin/viewer
            if (currentUser.role === 'admin' || currentUser.role === 'viewer') {
                updateFilters();
                applyFilters();
            }
            
            // Update connection status
            await checkDatabaseConnection();
            
            // Show success message with readable age
            const ageDisplay = formatAgeDisplay(ageInYears);
            showSuccessMessage(`‚úÖ Record added successfully! Case ID: ${recordData.caseId} (Age: ${ageDisplay})`);
            
            // Reset form after delay
            setTimeout(() => {
                closeAddRecordModal();
            }, 2000);
            
        } catch (error) {
            showErrorMessage(`‚ùå Error adding record: ${error.message}`);
        }
    });
});</parameter>
<parameter name="new_str">    // Login form handler
document.addEventListener('DOMContentLoaded', function() {
// Check for existing session
if (!checkSession()) {
showLoginScreen();
}
// Login form submission
    document.getElementById('loginForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const username = document.getElementById('username').value;
        const password = document.getElementById('password').value;
        
        if (login(username, password)) {
            document.getElementById('loginError').style.display = 'none';
        } else {
            document.getElementById('loginError').style.display = 'block';
        }
    });

    // Setup age input handlers
    setupAgeInputHandlers();
    
    // Form submission for adding records
    document.getElementById('addRecordForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        console.log('üìù Form submission started...');
        
        // Check permissions
        if (!hasPermission('add')) {
            showErrorMessage('‚ùå You do not have permission to add records.');
            return;
        }
        
        // Disable submit button to prevent double submission
        const submitBtn = e.target.querySelector('.submit-btn');
        const originalText = submitBtn.innerHTML;
        submitBtn.disabled = true;
        submitBtn.innerHTML = '‚è≥ Saving...';
        
        try {
            const formData = new FormData(e.target);
            const recordData = {};
            
            // Collect form data manually for better mobile compatibility
            recordData.caseId = document.getElementById('caseId').value;
            recordData.recordType = document.getElementById('recordType').value;
            recordData.dateReported = document.getElementById('dateReported').value;
            recordData.district = document.getElementById('district').value;
            recordData.cvwGender = document.getElementById('cvwGender').value;
            recordData.disability = document.getElementById('disability').value;
            recordData.cvwAge = document.getElementById('cvwAge').value;
            recordData.ageUnit = document.getElementById('ageUnit').value;
            recordData.servicesRendered = document.getElementById('servicesRendered').value;
            recordData.offenderGender = document.getElementById('offenderGender').value;
            recordData.crimeType = document.getElementById('crimeType').value;
            recordData.offenderAge = document.getElementById('offenderAge').value;
            recordData.relationshipToCv = document.getElementById('relationshipToCv').value;
            
            console.log('üìã Collected form data:', recordData);
            
            // Validate required fields
            const requiredFields = ['recordType', 'dateReported', 'district', 'cvwGender', 'crimeType', 'cvwAge', 'ageUnit'];
            const missingFields = requiredFields.filter(field => !recordData[field] || recordData[field].trim() === '');
            
            if (missingFields.length > 0) {
                showErrorMessage('Please fill in all required fields: ' + missingFields.join(', '));
                return;
            }
            
            // Check if agency is selected
            if (!selectedAgency) {
                showErrorMessage('‚ö†Ô∏è Please select a reporting agency first.');
                return;
            }
            
            // Convert age to years for database storage
            const originalAge = recordData.cvwAge;
            const originalUnit = recordData.ageUnit;
            const ageInYears = convertAgeToYears(originalAge, originalUnit);
            
            recordData.cvwAge = ageInYears;
            
            // Auto-generate case ID if needed
            if (!recordData.caseId) {
                await generateCaseId();
                recordData.caseId = document.getElementById('caseId').value;
            }
            
            console.log('üíæ Attempting to save record:', recordData);
            
            const result = await addRecord(recordData);
            
            // Update filters and dashboard for admin/viewer
            if (currentUser.role === 'admin' || currentUser.role === 'viewer') {
                updateFilters();
                applyFilters();
            }
            
            // Update connection status
            await checkDatabaseConnection();
            
            // Show success message with readable age
            const ageDisplay = formatAgeDisplay(ageInYears);
            showSuccessMessage(`‚úÖ Record added successfully! Case ID: ${recordData.caseId} (Age: ${ageDisplay})`);
            
            console.log('‚úÖ Record saved successfully!');
            
            // Reset form after delay
            setTimeout(() => {
                closeAddRecordModal();
            }, 2000);
            
        } catch (error) {
            console.error('‚ùå Form submission error:', error);
            showErrorMessage(`‚ùå Error adding record: ${error.message}`);
        } finally {
            // Re-enable submit button
            submitBtn.disabled = false;
            submitBtn.innerHTML = originalText;
        }
    });
});</parameter>
</invoke>
</artifacts>
<artifacts>
<invoke name="artifacts">
<parameter name="command">update</parameter>
<parameter name="id">cvw_dashboard_complete_final</parameter>
<parameter name="old_str">    function addRecordLocally(recordData) {
        const newRecord = {
            'cvw code': recordData.caseId,
            'Record Type': recordData.recordType,
            'Date Reported': new Date(recordData.dateReported),
            'District': recordData.district,
            'CVW Gender': recordData.cvwGender,
            'CVW Age': parseFloat(recordData.cvwAge) || 0,
            'Offender Gender': recordData.offenderGender || '',
            'Offender Age': parseInt(recordData.offenderAge) || 0,
            'Crime Type': recordData.crimeType,
            'Disability': recordData.disability || 'NON',
            'Services Rendered': recordData.servicesRendered || '',
            'Relationship to CV': recordData.relationshipToCv || ''
        };
allData.push(newRecord);
    filteredData = [...allData];
    
    // Save to localStorage for persistence
    saveDataToLocalStorage();
}</parameter>
<parameter name="new_str">    function addRecordLocally(recordData) {
console.log('üì± Adding record locally for mobile/offline use:', recordData);
const newRecord = {
        'cvw code': recordData.caseId,
        'Record Type': recordData.recordType,
        'Date Reported': new Date(recordData.dateReported),
        'District': recordData.district,
        'CVW Gender': recordData.cvwGender,
        'CVW Age': parseFloat(recordData.cvwAge) || 0,
        'Offender Gender': recordData.offenderGender || '',
        'Offender Age': parseInt(recordData.offenderAge) || 0,
        'Crime Type': recordData.crimeType,
        'Disability': recordData.disability || 'NON',
        'Services Rendered': recordData.servicesRendered || '',
        'Relationship to CV': recordData.relationshipToCv || ''
    };
    
    allData.push(newRecord);
    filteredData = [...allData];
    
    // Save to localStorage for persistence
    saveDataToLocalStorage();
    
    // Force update for mobile
    if (currentUser && (currentUser.role === 'admin' || currentUser.role === 'viewer')) {
        updateFilters();
        updateDashboard();
    }
    
    console.log('üíæ Record saved locally. Total records:', allData.length);
}</parameter>
</invoke>
</artifacts>
<artifacts>
<invoke name="artifacts">
<parameter name="command">update</parameter>
<parameter name="id">cvw_dashboard_complete_final</parameter>
<parameter name="old_str">    // Save data to localStorage for persistence
    function saveDataToLocalStorage() {
        try {
            const dataToSave = allData.map(record => ({
                ...record,
                'Date Reported': record['Date Reported'].toISOString() // Convert date to string for storage
            }));
            localStorage.setItem('cvw_dashboard_data', JSON.stringify(dataToSave));
            console.log('üíæ Data saved to localStorage:', allData.length, 'records');
        } catch (error) {
            console.error('Error saving to localStorage:', error);
        }
    }</parameter>
<parameter name="new_str">    // Save data to localStorage for persistence
    function saveDataToLocalStorage() {
        try {
            const dataToSave = allData.map(record => ({
                ...record,
                'Date Reported': record['Date Reported'].toISOString() // Convert date to string for storage
            }));
            localStorage.setItem('cvw_dashboard_data', JSON.stringify(dataToSave));
            console.log('üíæ Data saved to localStorage:', allData.length, 'records');
// Also save a backup with timestamp for mobile
        const backupKey = `cvw_backup_${Date.now()}`;
        localStorage.setItem(backupKey, JSON.stringify(dataToSave));
        
        // Keep only last 5 backups to avoid storage overflow
        const allKeys = Object.keys(localStorage).filter(key => key.startsWith('cvw_backup_'));
        if (allKeys.length > 5) {
            allKeys.sort().slice(0, allKeys.length - 5).forEach(key => {
                localStorage.removeItem(key);
            });
        }
        
    } catch (error) {
        console.error('‚ùå Error saving to localStorage:', error);
        alert('‚ö†Ô∏è Storage error - your device may be low on storage space. Please clear some space and try again.');
    }
}</parameter>
</invoke>
</artifacts>
<artifacts>
<invoke name="artifacts">
<parameter name="command">update</parameter>
<parameter name="id">cvw_dashboard_complete_final</parameter>
<parameter name="old_str">    // Modal functions
    function openAddRecordModal() {
        // Check permissions
        if (!hasPermission('add')) {
            alert('‚ùå You do not have permission to add records.');
            return;
        }
// Check if agency is selected
    if (!selectedAgency) {
        alert('‚ö†Ô∏è Please select a reporting agency first.');
        return;
    }
    
    document.getElementById('addRecordModal').style.display = 'block';
    document.getElementById('dateReported').value = new Date().toISOString().split('T')[0];
    document.getElementById('caseId').value = '';
    
    // Update modal title to show selected agency
    const agencyNames = {
        'NPA': 'National Prosecution Authority',
        'MOH': 'Ministry of Health', 
        'ZP': 'Zambia Police'
    };
    document.querySelector('.modal-title').innerHTML = `‚ûï Add New Case Record - ${agencyNames[selectedAgency]}`;
}</parameter>
<parameter name="new_str">    // Modal functions
function openAddRecordModal() {
// Check permissions
if (!hasPermission('add')) {
alert('‚ùå You do not have permission to add records.');
return;
}
// Check if agency is selected
    if (!selectedAgency) {
        alert('‚ö†Ô∏è Please select a reporting agency first.');
        return;
    }
    
    console.log('üì± Opening add record modal on mobile device');
    
    document.getElementById('addRecordModal').style.display = 'block';
    document.getElementById('dateReported').value = new Date().toISOString().split('T')[0];
    document.getElementById('caseId').value = '';
    
    // Update modal title to show selected agency
    const agencyNames = {
        'NPA': 'National Prosecution Authority',
        'MOH': 'Ministry of Health', 
        'ZP': 'Zambia Police'
    };
    document.querySelector('.modal-title').innerHTML = `‚ûï Add New Case Record - ${agencyNames[selectedAgency]}`;
    
    // Mobile-specific adjustments
    if (window.innerWidth <= 768) {
        document.body.style.overflow = 'hidden';
        const modal = document.getElementById('addRecordModal');
        modal.style.position = 'fixed';
        modal.style.top = '0';
        modal.style.left = '0';
        modal.style.width = '100%';
        modal.style.height = '100%';
        modal.style.zIndex = '9999';
    }
}</parameter>
</invoke>
</artifacts>
<artifacts>
<invoke name="artifacts">
<parameter name="command">update</parameter>
<parameter name="id">cvw_dashboard_complete_final</parameter>
<parameter name="old_str">    function closeAddRecordModal() {
        document.getElementById('addRecordModal').style.display = 'none';
        document.getElementById('addRecordForm').reset();
        hideMessages();
        // Reset age input styling
        const ageInput = document.getElementById('cvwAge');
        if (ageInput) {
            ageInput.style.borderColor = '#dee2e6';
            ageInput.style.backgroundColor = 'white';
        }
    }</parameter>
<parameter name="new_str">    function closeAddRecordModal() {
        console.log('üì± Closing add record modal');
document.getElementById('addRecordModal').style.display = 'none';
    document.getElementById('addRecordForm').reset();
    hideMessages();
    
    // Reset age input styling
    const ageInput = document.getElementById('cvwAge');
    if (ageInput) {
        ageInput.style.borderColor = '#dee2e6';
        ageInput.style.backgroundColor = 'white';
    }
    
    // Reset mobile-specific adjustments
    if (window.innerWidth <= 768) {
        document.body.style.overflow = 'auto';
    }
    
    // Reset agency selection for mobile users who might switch
    updateRelationshipLabel();
}</parameter>
</invoke>
</artifacts>
<artifacts>
<invoke name="artifacts">
<parameter name="command">update</parameter>
<parameter name="id">cvw_dashboard_complete_final</parameter>
<parameter name="old_str">        @media (max-width: 768px) {
            .dashboard-container {
                padding: 15px;
            }
.header h1 {
            font-size: 2rem;
        }
        
        .charts-grid {
            grid-template-columns: 1fr;
        }
        
        .filters-grid {
            grid-template-columns: 1fr;
        }

        .form-grid {
            grid-template-columns: 1fr;
        }

        .modal-content {
            width: 95%;
            margin: 5% auto;
            padding: 20px;
        }

        .action-buttons {
            flex-direction: column;
            align-items: center;
        }

        .age-input-container {
            flex-direction: column;
            gap: 8px;
        }

        .age-input-container input,
        .age-input-container select {
            flex: none;
            width: 100%;
        }

        .user-info-bar {
            flex-direction: column;
            gap: 10px;
            text-align: center;
        }

        #agencySelection {
            margin-bottom: 10px;
        }

        #agencySelection > div {
            flex-direction: column;
            gap: 10px;
        }

        .agency-btn {
            min-width: auto;
            width: 100%;
        }
    }</parameter>
<parameter name="new_str">        @media (max-width: 768px) {
.dashboard-container {
padding: 15px;
}
.header h1 {
            font-size: 2rem;
        }
        
        .charts-grid {
            grid-template-columns: 1fr;
        }
        
        .filters-grid {
            grid-template-columns: 1fr;
        }

        .form-grid {
            grid-template-columns: 1fr;
        }

        .modal-content {
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 15px;
            border-radius: 0;
            max-height: 100vh;
            overflow-y: auto;
        }

        .modal {
            padding: 0;
        }

        .action-buttons {
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }

        .action-btn {
            width: 90%;
            max-width: 300px;
            padding: 15px;
            font-size: 16px;
        }

        .age-input-container {
            flex-direction: column;
            gap: 8px;
        }

        .age-input-container input,
        .age-input-container select {
            flex: none;
            width: 100%;
            padding: 15px;
            font-size: 16px;
        }

        .form-group input,
        .form-group select {
            padding: 15px;
            font-size: 16px;
            border-radius: 8px;
        }

        .user-info-bar {
            flex-direction: column;
            gap: 10px;
            text-align: center;
        }

        #agencySelection {
            margin-bottom: 10px;
        }

        #agencySelection > div {
            flex-direction: column;
            gap: 10px;
        }

        .agency-btn {
            min-width: auto;
            width: 100%;
            padding: 25px 15px;
            font-size: 14px;
        }

        .login-container {
            margin: 5% auto;
            width: 95%;
            padding: 30px 20px;
        }

        .submit-btn, .cancel-btn {
            padding: 15px 25px;
            font-size: 16px;
            min-height: 50px;
        }

        /* Mobile form improvements */
        .form-group label {
            font-size: 16px;
            margin-bottom: 10px;
        }

        .modal-title {
            font-size: 1.3rem;
            line-height: 1.4;
        }

        /* Ensure tap targets are at least 44px */
        button, .action-btn, .agency-btn {
            min-height: 44px;
            touch-action: manipulation;
        }

        /* Prevent zoom on input focus for iOS */
        input, select, textarea {
            font-size: 16px !important;
            transform-origin: left top;
        }
    }</parameter>
</invoke>
</artifacts>
