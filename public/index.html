<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>CVW Case Reports Analytics Dashboard</title>
<style>
/* Keep your existing styles here â€” omitted for brevity */
</style>
</head>
<body>
<!-- Login -->
<div id="loginScreen">
    <h1>Login</h1>
    <input type="text" id="username" placeholder="Username">
    <input type="password" id="password" placeholder="Password">
    <button onclick="login()">Login</button>
</div>

<!-- Dashboard -->
<div id="mainDashboard" style="display:none;">
    <h1>Dashboard</h1>
    <div>
        <input type="text" id="searchInput" placeholder="Enter Case ID">
        <button onclick="searchRecord()">Search</button>
        <button onclick="clearSearch()">Clear</button>
    </div>
    <div id="searchResults"></div>
</div>

<script>
let allData = [];
let searchResultsData = [];
let currentUser = null;

const availableServices = [
    'MEDICAL REPORT', 'COUNSELLING', 'MEDICAL + COUNSELLING',
    'LEGAL AID', 'PSYCHOSOCIAL SUPPORT', 'SHELTER', 'REFERRAL TO SPECIALIST'
];

const users = {
    'admin': {
        password: 'admin123', role: 'admin', name: 'Administrator',
        agency: 'NPA', permissions: ['view','add','edit','delete','admin','search','append_services']
    },
    'viewer': {
        password: 'view123', role: 'viewer', name: 'Data Viewer',
        agency: 'MOH', permissions: ['view','search','append_services']
    },
    'reporter': {
        password: 'report123', role: 'reporter', name: 'Case Reporter',
        agency: 'ZP', permissions: ['add','search','append_services']
    }
};

function initializeSampleData() {
    allData = [
        {
            'cvw code': 'NPA-CV1',
            'Record Type': 'Victim',
            'Date Reported': new Date('2025-01-04'),
            'District': 'Lusaka',
            'CVW Gender': 'MALE',
            'CVW Age': 5,
            'Crime Type': 'ASSAULT ON A CHILD',
            'Disability': 'NON',
            'Services Rendered': 'MEDICAL REPORT',
            'Relationship to CV': 'STRANGER',
            'Agency': 'NPA',
            'Service History': [
                { provider: 'admin', service: 'MEDICAL REPORT' }
            ]
        },
        {
            'cvw code': 'MOH-CW5',
            'Record Type': 'Witness',
            'Date Reported': new Date('2025-02-07'),
            'District': 'Katete',
            'CVW Gender': 'MALE',
            'CVW Age': 15,
            'Crime Type': 'RAPE',
            'Disability': 'NON',
            'Services Rendered': 'COUNSELLING',
            'Relationship to CV': 'FRIEND',
            'Agency': 'MOH',
            'Service History': [
                { provider: 'viewer', service: 'COUNSELLING' }
            ]
        },
        {
            'cvw code': 'ZP-CV4',
            'Record Type': 'Victim',
            'Date Reported': new Date('2025-03-11'),
            'District': 'Lusaka',
            'CVW Gender': 'FEMALE',
            'CVW Age': 12,
            'Crime Type': 'RAPE',
            'Disability': 'MENTAL+PHYSICAL',
            'Services Rendered': 'MEDICAL + COUNSELLING',
            'Relationship to CV': 'FATHER',
            'Agency': 'ZP',
            'Service History': [
                { provider: 'reporter', service: 'MEDICAL + COUNSELLING' }
            ]
        }
    ];
}

function login() {
    const username = document.getElementById('username').value.trim();
    const password = document.getElementById('password').value.trim();
    if (users[username] && users[username].password === password) {
        currentUser = { username, ...users[username] };
        initializeSampleData();
        document.getElementById('loginScreen').style.display = 'none';
        document.getElementById('mainDashboard').style.display = 'block';
    } else {
        alert("Invalid credentials");
    }
}

function searchRecord() {
    const term = document.getElementById('searchInput').value.trim().toUpperCase();
    if (!term) return;
    searchResultsData = allData.filter(r => r['cvw code'].toUpperCase() === term);
    displaySearchResults();
}

function displaySearchResults() {
    const container = document.getElementById('searchResults');
    container.innerHTML = '';
    if (!searchResultsData.length) {
        container.innerHTML = '<p>No records found</p>';
        return;
    }
    searchResultsData.forEach((record, idx) => {
        const canAppend = currentUser.permissions.includes('append_services') &&
            (record.Agency === currentUser.agency ||
             record['Service History'].some(s => s.provider === currentUser.username));

        let servicesHTML = record['Services Rendered']
            .split('+')
            .map(s => `<span class="service-badge">${s.trim()}</span>`).join(' ');

        let addServiceHTML = '';
        if (canAppend) {
            addServiceHTML = `
                <select id="serviceSelect_${idx}">
                    <option value="">-- Add Service --</option>
                    ${availableServices.map(s => `<option value="${s}">${s}</option>`).join('')}
                </select>
                <button onclick="appendService(${idx})">Add</button>
            `;
        }

        container.innerHTML += `
            <div style="border:1px solid #ccc; padding:10px; margin:10px;">
                <strong>${record['cvw code']}</strong> - ${record['Record Type']}<br>
                Agency: ${record.Agency}<br>
                Date: ${record['Date Reported'].toLocaleDateString()}<br>
                District: ${record['District']}<br>
                Gender: ${record['CVW Gender']} | Age: ${record['CVW Age']}<br>
                Crime: ${record['Crime Type']}<br>
                Disability: ${record['Disability']}<br>
                Relationship: ${record['Relationship to CV']}<br>
                <div><strong>Services Rendered:</strong> ${servicesHTML}</div>
                ${addServiceHTML}
            </div>
        `;
    });
}

function appendService(index) {
    const record = searchResultsData[index];
    const selectEl = document.getElementById(`serviceSelect_${index}`);
    const newService = selectEl.value.trim();
    if (!newService) return;

    let existing = record['Services Rendered'].split('+').map(s => s.trim());
    if (existing.includes(newService)) {
        alert("Service already exists");
        return;
    }
    existing.push(newService);
    record['Services Rendered'] = existing.join(' + ');
    record['Service History'].push({ provider: currentUser.username, service: newService });

    // Update master data
    const globalIndex = allData.findIndex(r => r['cvw code'] === record['cvw code']);
    if (globalIndex !== -1) allData[globalIndex] = record;

    displaySearchResults();
}

function clearSearch() {
    document.getElementById('searchInput').value = '';
    document.getElementById('searchResults').innerHTML = '';
}
</script>
</body>
</html>
