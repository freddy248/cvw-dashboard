<artifacts>
<invoke name="artifacts">
<parameter name="command">update</parameter>
<parameter name="id">cvw_dashboard_complete_final</parameter>
<parameter name="old_str">            <!-- Action Buttons (Role-based visibility) -->
            <div class="action-buttons" id="actionButtons">
                <button class="action-btn add-record-btn" id="addRecordBtn" onclick="openAddRecordModal()" disabled>
                    ‚ûï Add New Record
                </button>
                <button class="action-btn view-dashboard-btn" id="viewDashboardBtn" onclick="showDashboardView()">
                    üìà View Dashboard
                </button>
                <button class="action-btn" id="clearDataBtn" style="background: linear-gradient(135deg, #ff6b6b, #ee5a52);" onclick="clearAllData()" title="Clear all locally saved data">
                    üóëÔ∏è Clear Data
                </button>
            </div></parameter>
<parameter name="new_str">            <!-- Action Buttons (Role-based visibility) -->
            <div class="action-buttons" id="actionButtons">
                <button class="action-btn add-record-btn" id="addRecordBtn" onclick="openAddRecordModal()" disabled>
                    ‚ûï Add New Record
                </button>
                <button class="action-btn" id="searchCaseBtn" style="background: linear-gradient(135deg, #17a2b8, #6f42c1);" onclick="openSearchCaseModal()" disabled>
                    üîç Search Case
                </button>
                <button class="action-btn view-dashboard-btn" id="viewDashboardBtn" onclick="showDashboardView()">
                    üìà View Dashboard
                </button>
                <button class="action-btn" id="clearDataBtn" style="background: linear-gradient(135deg, #ff6b6b, #ee5a52);" onclick="clearAllData()" title="Clear all locally saved data">
                    üóëÔ∏è Clear Data
                </button>
            </div></parameter>
</invoke>
</artifacts>
<artifacts>
<invoke name="artifacts">
<parameter name="command">update</parameter>
<parameter name="id">cvw_dashboard_complete_final</parameter>
<parameter name="old_str">        // Enable add record button
        document.getElementById('addRecordBtn').disabled = false;
// Update button text to show selected agency
    const agencyNames = {
        'NPA': 'National Prosecution Authority',
        'MOH': 'Ministry of Health', 
        'ZP': 'Zambia Police'
    };
    document.getElementById('addRecordBtn').innerHTML = `‚ûï Add New Record (${agencyNames[agency]})`;
    
    console.log(`üìã Selected agency: ${agency} - ${agencyNames[agency]}`);</parameter>
<parameter name="new_str">        // Enable add record and search buttons
document.getElementById('addRecordBtn').disabled = false;
document.getElementById('searchCaseBtn').disabled = false;
// Update button text to show selected agency
    const agencyNames = {
        'NPA': 'National Prosecution Authority',
        'MOH': 'Ministry of Health', 
        'ZP': 'Zambia Police'
    };
    document.getElementById('addRecordBtn').innerHTML = `‚ûï Add New Record (${agencyNames[agency]})`;
    document.getElementById('searchCaseBtn').innerHTML = `üîç Search Case (${agencyNames[agency]})`;
    
    console.log(`üìã Selected agency: ${agency} - ${agencyNames[agency]}`);</parameter>
</invoke>
</artifacts>
<artifacts>
<invoke name="artifacts">
<parameter name="command">update</parameter>
<parameter name="id">cvw_dashboard_complete_final</parameter>
<parameter name="old_str">        // Reset agency selection and button state
        selectedAgency = null;
        document.getElementById('addRecordBtn').disabled = true;
        document.querySelectorAll('.agency-btn').forEach(btn => btn.classList.remove('selected'));</parameter>
<parameter name="new_str">        // Reset agency selection and button state
        selectedAgency = null;
        document.getElementById('addRecordBtn').disabled = true;
        document.getElementById('searchCaseBtn').disabled = true;
        document.querySelectorAll('.agency-btn').forEach(btn => btn.classList.remove('selected'));</parameter>
</invoke>
</artifacts>
<artifacts>
<invoke name="artifacts">
<parameter name="command">update</parameter>
<parameter name="id">cvw_dashboard_complete_final</parameter>
<parameter name="old_str">    </div>
</div>
<script></parameter>
<parameter name="new_str">    </div>
</div>

<!-- Search Case Modal -->
<div id="searchCaseModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 class="modal-title">üîç Search Case by ID</h2>
            <span class="close" onclick="closeSearchCaseModal()">&times;</span>
        </div>
        
        <div class="success-message" id="searchSuccessMessage">
            ‚úÖ Case found successfully!
        </div>
        
        <div class="error-message" id="searchErrorMessage">
            ‚ùå Case not found.
        </div>

        <!-- Search Form -->
        <div style="margin-bottom: 30px;">
            <div class="form-group">
                <label for="searchCaseId">Enter Case ID</label>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <input type="text" id="searchCaseId" placeholder="e.g., NPA-CV1, MOH-CW5, ZP-CV12" style="flex: 1; padding: 12px; border: 2px solid #dee2e6; border-radius: 8px; font-size: 16px;">
                    <button onclick="searchCase()" style="padding: 12px 20px; background: linear-gradient(135deg, #17a2b8, #6f42c1); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">üîç Search</button>
                </div>
                <small style="color: #666; margin-top: 5px;">Format: [AGENCY]-[CV/CW][NUMBER] - Search cases from any agency</small>
            </div>
        </div>

        <!-- Case Details Display -->
        <div id="caseDetailsSection" class="hidden">
            <h3 style="color: #2c3e50; margin-bottom: 20px; border-bottom: 2px solid #ecf0f1; padding-bottom: 10px;">üìã Case Details</h3>
            
            <div class="form-grid">
                <div class="form-group">
                    <label>Case ID</label>
                    <input type="text" id="foundCaseId" readonly style="background: #f8f9fa; border: 1px solid #dee2e6; padding: 12px; border-radius: 8px;">
                </div>
                <div class="form-group">
                    <label>Reporting Agency</label>
                    <input type="text" id="foundReportingAgency" readonly style="background: #f8f9fa; border: 1px solid #dee2e6; padding: 12px; border-radius: 8px;">
                </div>
                <div class="form-group">
                    <label>Record Type</label>
                    <input type="text" id="foundRecordType" readonly style="background: #f8f9fa; border: 1px solid #dee2e6; padding: 12px; border-radius: 8px;">
                </div>
                <div class="form-group">
                    <label>Date Reported</label>
                    <input type="text" id="foundDateReported" readonly style="background: #f8f9fa; border: 1px solid #dee2e6; padding: 12px; border-radius: 8px;">
                </div>
                <div class="form-group">
                    <label>District</label>
                    <input type="text" id="foundDistrict" readonly style="background: #f8f9fa; border: 1px solid #dee2e6; padding: 12px; border-radius: 8px;">
                </div>
                <div class="form-group">
                    <label>CVW Gender</label>
                    <input type="text" id="foundCvwGender" readonly style="background: #f8f9fa; border: 1px solid #dee2e6; padding: 12px; border-radius: 8px;">
                </div>
                <div class="form-group">
                    <label>CVW Age</label>
                    <input type="text" id="foundCvwAge" readonly style="background: #f8f9fa; border: 1px solid #dee2e6; padding: 12px; border-radius: 8px;">
                </div>
                <div class="form-group">
                    <label>Crime Type</label>
                    <input type="text" id="foundCrimeType" readonly style="background: #f8f9fa; border: 1px solid #dee2e6; padding: 12px; border-radius: 8px;">
                </div>
                <div class="form-group">
                    <label>Disability</label>
                    <input type="text" id="foundDisability" readonly style="background: #f8f9fa; border: 1px solid #dee2e6; padding: 12px; border-radius: 8px;">
                </div>
                <div class="form-group full-width">
                    <label>Current Services Rendered</label>
                    <textarea id="foundServicesRendered" readonly style="background: #f8f9fa; border: 1px solid #dee2e6; padding: 12px; border-radius: 8px; min-height: 100px; resize: vertical;"></textarea>
<small style="color: #666; margin-top: 5px;">This shows all services provided by different agencies</small>
            </div>
        </div>

        <!-- Add Service Section -->
        <div style="margin-top: 30px; padding: 25px; background: linear-gradient(135deg, #e3f2fd, #f3e5f5); border-radius: 15px; border: 2px solid #2196f3;">
            <h4 style="color: #1976d2; margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                ‚ûï Add Service by Your Agency
                <span id="currentAgencyBadge" style="background: #1976d2; color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.8rem;"></span>
            </h4>
            <p style="color: #1565c0; margin-bottom: 20px; line-height: 1.4;">
                <strong>Inter-Agency Collaboration:</strong> Add additional services that your agency has provided to this case. 
                This will be tracked with your agency name and date.
            </p>
            
            <div class="form-grid">
                <div class="form-group">
                    <label for="additionalService">Service Provided by Your Agency *</label>
                    <select id="additionalService" style="padding: 12px; border: 2px solid #dee2e6; border-radius: 8px; font-size: 16px;">
                        <option value="">Select Service</option>
                        <option value="MEDICAL REPORT">Medical Report</option>
                        <option value="COUNSELLING">Counselling</option>
                        <option value="MEDICAL + COUNSELLING">Medical + Counselling</option>
                        <option value="LEGAL SUPPORT">Legal Support</option>
                        <option value="PSYCHOSOCIAL SUPPORT">Psychosocial Support</option>
                        <option value="SAFE HOUSE PLACEMENT">Safe House Placement</option>
                        <option value="FAMILY MEDIATION">Family Mediation</option>
                        <option value="COURT PREPARATION">Court Preparation</option>
                        <option value="FOLLOW-UP VISIT">Follow-up Visit</option>
                        <option value="CHILD PROTECTION SERVICES">Child Protection Services</option>
                        <option value="EMERGENCY ACCOMMODATION">Emergency Accommodation</option>
                        <option value="EDUCATIONAL SUPPORT">Educational Support</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="serviceDate">Date Service Provided *</label>
                    <input type="date" id="serviceDate" style="padding: 12px; border: 2px solid #dee2e6; border-radius: 8px; font-size: 16px;">
                </div>
            </div>

            <div class="form-group">
                <label for="serviceNotes">Service Notes (Optional)</label>
                <textarea id="serviceNotes" placeholder="Additional details about the service provided..." style="padding: 12px; border: 2px solid #dee2e6; border-radius: 8px; min-height: 80px; resize: vertical; font-size: 16px;"></textarea>
            </div>
            
            <button onclick="addServiceToCase()" style="padding: 15px 30px; background: linear-gradient(135deg, #10b981, #059669); color: white; border: none; border-radius: 10px; cursor: pointer; font-weight: 600; font-size: 16px; margin-top: 15px; display: flex; align-items: center; gap: 8px; min-height: 50px;">
                ‚úÖ Add Service to Case
            </button>
            
            <div style="margin-top: 15px; padding: 15px; background: rgba(255, 255, 255, 0.7); border-radius: 8px; border-left: 4px solid #ff9800;">
                <strong>üìã Service Tracking Format:</strong><br>
                <small style="color: #666;">Your service will be added as: "<em>[SERVICE] ([YOUR_AGENCY] - [DATE]) [Notes if provided]</em>"</small>
            </div>
        </div>
    </div>
    
    <div class="form-actions">
        <button type="button" class="cancel-btn" onclick="closeSearchCaseModal()">Close</button>
    </div>
</div>
</div>
<script></parameter>
</invoke>
</artifacts>

<artifacts>
<invoke name="artifacts">
<parameter name="command">update</parameter>
<parameter name="id">cvw_dashboard_complete_final</parameter>
<parameter name="old_str">    // Close modal when clicking outside
    window.onclick = function(event) {
        const modal = document.getElementById('addRecordModal');
        if (event.target == modal) {
            closeAddRecordModal();
        }
    }</parameter>
<parameter name="new_str">    // Search Case Functions
    function openSearchCaseModal() {
        // Check if agency is selected
        if (!selectedAgency) {
            alert('‚ö†Ô∏è Please select a reporting agency first.');
            return;
        }
        
        console.log('üîç Opening search case modal for agency:', selectedAgency);
        
        document.getElementById('searchCaseModal').style.display = 'block';
        document.getElementById('searchCaseId').value = '';
        document.getElementById('caseDetailsSection').classList.add('hidden');
        document.getElementById('serviceDate').value = new Date().toISOString().split('T')[0];
        
        // Update current agency badge
        const agencyNames = {
            'NPA': 'National Prosecution Authority',
            'MOH': 'Ministry of Health', 
            'ZP': 'Zambia Police'
        };
        document.getElementById('currentAgencyBadge').textContent = `${selectedAgency} - ${agencyNames[selectedAgency]}`;
        
        hideSearchMessages();
        
        // Mobile-specific adjustments
        if (window.innerWidth <= 768) {
            document.body.style.overflow = 'hidden';
            const modal = document.getElementById('searchCaseModal');
            modal.style.position = 'fixed';
            modal.style.top = '0';
            modal.style.left = '0';
            modal.style.width = '100%';
            modal.style.height = '100%';
            modal.style.zIndex = '9999';
        }
    }

    function closeSearchCaseModal() {
        console.log('üîç Closing search case modal');
        
        document.getElementById('searchCaseModal').style.display = 'none';
        document.getElementById('caseDetailsSection').classList.add('hidden');
        hideSearchMessages();
        
        // Reset mobile-specific adjustments
        if (window.innerWidth <= 768) {
            document.body.style.overflow = 'auto';
        }
    }

    function searchCase() {
        const caseId = document.getElementById('searchCaseId').value.trim().toUpperCase();
        
        if (!caseId) {
            showSearchErrorMessage('Please enter a Case ID');
            return;
        }
        
        console.log('üîç Searching for case:', caseId);
        
        // Search in allData for the case
        const foundCase = allData.find(record => record['cvw code'].toUpperCase() === caseId);
        
        if (foundCase) {
            console.log('‚úÖ Case found:', foundCase);
            displayCaseDetails(foundCase);
            showSearchSuccessMessage(`Case ${caseId} found! You can now add services provided by your agency.`);
        } else {
            console.log('‚ùå Case not found:', caseId);
            document.getElementById('caseDetailsSection').classList.add('hidden');
            showSearchErrorMessage(`Case ${caseId} not found in the system. Please verify the Case ID format (e.g., NPA-CV1, MOH-CW5, ZP-CV12).`);
        }
    }

    function displayCaseDetails(caseData) {
        // Extract reporting agency from case ID
        const reportingAgency = caseData['cvw code'].split('-')[0];
        const agencyNames = {
            'NPA': 'National Prosecution Authority',
            'MOH': 'Ministry of Health', 
            'ZP': 'Zambia Police'
        };
        
        document.getElementById('foundCaseId').value = caseData['cvw code'];
        document.getElementById('foundReportingAgency').value = `${reportingAgency} - ${agencyNames[reportingAgency] || 'Unknown Agency'}`;
        document.getElementById('foundRecordType').value = caseData['Record Type'];
        document.getElementById('foundDateReported').value = caseData['Date Reported'].toLocaleDateString();
        document.getElementById('foundDistrict').value = caseData['District'];
        document.getElementById('foundCvwGender').value = caseData['CVW Gender'];
        document.getElementById('foundCvwAge').value = formatAgeDisplay(caseData['CVW Age']);
        document.getElementById('foundCrimeType').value = caseData['Crime Type'];
        document.getElementById('foundDisability').value = caseData['Disability'] || 'NON';
        
        // Display services with better formatting
        const currentServices = caseData['Services Rendered'] || 'No services recorded yet';
        document.getElementById('foundServicesRendered').value = currentServices;
        
        // Clear additional service form
        document.getElementById('additionalService').value = '';
        document.getElementById('serviceNotes').value = '';
        
        document.getElementById('caseDetailsSection').classList.remove('hidden');
        
        // Scroll to case details
        document.getElementById('caseDetailsSection').scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    function addServiceToCase() {
        const caseId = document.getElementById('foundCaseId').value;
        const additionalService = document.getElementById('additionalService').value;
        const serviceDate = document.getElementById('serviceDate').value;
        const serviceNotes = document.getElementById('serviceNotes').value.trim();
        
        if (!additionalService) {
            showSearchErrorMessage('Please select a service that your agency provided');
            return;
        }
        
        if (!serviceDate) {
            showSearchErrorMessage('Please enter the date when the service was provided');
            return;
        }
        
        // Check if service date is not in the future
        const today = new Date().toISOString().split('T')[0];
        if (serviceDate > today) {
            showSearchErrorMessage('Service date cannot be in the future');
            return;
        }
        
        console.log('‚ûï Adding service to case:', caseId, 'Service:', additionalService, 'by', selectedAgency);
        
        // Find the case in allData
        const caseIndex = allData.findIndex(record => record['cvw code'] === caseId);
        
        if (caseIndex !== -1) {
            const currentServices = allData[caseIndex]['Services Rendered'] || '';
            const agencyPrefix = selectedAgency;
            
            // Create service entry with agency, date, and notes
            let newServiceEntry = `${additionalService} (${agencyPrefix} - ${new Date(serviceDate).toLocaleDateString()})`;
            if (serviceNotes) {
                newServiceEntry += ` [${serviceNotes}]`;
            }
            
            // Update services rendered
            let updatedServices;
            if (currentServices && currentServices !== 'No services recorded yet' && currentServices !== 'No services recorded') {
                updatedServices = `${currentServices} + ${newServiceEntry}`;
            } else {
                updatedServices = newServiceEntry;
            }
            
            // Update the case data
            allData[caseIndex]['Services Rendered'] = updatedServices;
            
            // Update the display
            document.getElementById('foundServicesRendered').value = updatedServices;
            
            // Save to localStorage
            saveDataToLocalStorage();
            
            // Update dashboard if visible
            if (currentUser && (currentUser.role === 'admin' || currentUser.role === 'viewer')) {
                updateFilters();
                updateDashboard();
            }
            
            const agencyNames = {
                'NPA': 'National Prosecution Authority',
                'MOH': 'Ministry of Health', 
                'ZP': 'Zambia Police'
            };
            
            showSearchSuccessMessage(`‚úÖ Service "${additionalService}" successfully added to case ${caseId} by ${agencyNames[selectedAgency]} (${selectedAgency})`);
            
            // Clear the form
            document.getElementById('additionalService').value = '';
            document.getElementById('serviceNotes').value = '';
            
            console.log('‚úÖ Inter-agency service collaboration recorded successfully');
        } else {
            showSearchErrorMessage('Error: Case not found in database. Please try searching again.');
        }
    }

    function showSearchSuccessMessage(message) {
        const successMsg = document.getElementById('searchSuccessMessage');
        successMsg.textContent = message;
        successMsg.style.display = 'block';
        document.getElementById('searchErrorMessage').style.display = 'none';
        setTimeout(() => {
            successMsg.style.display = 'none';
        }, 6000);
    }

    function showSearchErrorMessage(message) {
        const errorMsg = document.getElementById('searchErrorMessage');
        errorMsg.textContent = message;
        errorMsg.style.display = 'block';
        document.getElementById('searchSuccessMessage').style.display = 'none';
        setTimeout(() => {
            errorMsg.style.display = 'none';
        }, 6000);
    }

    function hideSearchMessages() {
        document.getElementById('searchSuccessMessage').style.display = 'none';
        document.getElementById('searchErrorMessage').style.display = 'none';
    }

    // Close modal when clicking outside
    window.onclick = function(event) {
        const addModal = document.getElementById('addRecordModal');
        const searchModal = document.getElementById('searchCaseModal');
        
        if (event.target == addModal) {
            closeAddRecordModal();
        }
        if (event.target == searchModal) {
            closeSearchCaseModal();
        }
    }</parameter>
</invoke>
</artifacts>
